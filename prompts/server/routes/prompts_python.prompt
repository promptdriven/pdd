% You are an expert Python engineer. Your goal is to write `pdd/server/routes/prompts.py`.

% Role & Scope
  This module provides REST API endpoints for prompt analysis, preprocessing,
  sync status, model listing, match checking, diff analysis, and git versioning.

<context.python_preamble><include>context/python_preamble.prompt</include></context.python_preamble>

% Documentation References
  - FastAPI Routers: https://fastapi.tiangolo.com/tutorial/bigger-applications/
  - Pydantic Models: https://docs.pydantic.dev/latest/

% Requirements
  1. **POST /analyze**:
     - Body: path (required), model (optional, default "claude-sonnet-4-20250514"),
       preprocess (optional, default true), content (optional for direct analysis)
     - Returns: raw_content, processed_content (if preprocess), raw_metrics,
       processed_metrics, preprocessing_succeeded, preprocessing_error
     - Size limit: 500KB for both file reading and direct content
     - If content provided, analyze it instead of reading from file
     - Preprocess using pdd.preprocess with recursive=True, double_curly_brackets=True

  2. **GET /sync-status**:
     - Query params: basename (module name), language (e.g., "python")
     - Returns SyncStatusResponse with status, timestamps, modification flags
     - Status: "in_sync", "prompt_changed", "code_changed", "conflict", "never_synced"
     - Uses read_fingerprint, get_pdd_file_paths, calculate_sha256 from sync_determine_operation

  3. **GET /models**:
     - Returns ModelsResponse with list of available LLM models sorted by ELO descending
     - Each ModelInfo includes: model, provider, costs, elo, context_limit, reasoning info
     - Loads from llm_model.csv via _load_model_data

  4. **POST /check-match**:
     - Body: MatchCheckRequest with prompt_content, code_content, strength
     - Uses llm_invoke to evaluate prompt-code match
     - Returns: result (match_score, summary, missing, extra, suggestions), cost, model

  5. **POST /diff-analysis**:
     - Body: prompt_content, code_content, strength, mode, include_tests, prompt_path, code_path
     - mode: "quick" (capped strength 0.25) or "detailed"
     - Uses load_prompt_template("prompt_code_diff_LLM") for analysis
     - Returns bidirectional analysis: promptToCodeScore, codeToPromptScore, sections, codeSections
     - Includes hiddenKnowledge, lineMappings, stats with coverage metrics
     - In-memory caching with 10-minute TTL based on content hash
     - If include_tests=true, auto-finds and includes test files in analysis

  6. **POST /git-history**:
     - Body: prompt_path, limit (default 10)
     - Returns git commit history for the prompt file
     - Response: versions (list with commit_hash, date, message, author, content),
       current_content, has_uncommitted_changes

  7. **POST /prompt-diff**:
     - Body: prompt_path, version_a, version_b, code_path (optional), strength
     - Versions: commit hash, "HEAD", or "working" (working directory)
     - Auto-orders versions chronologically (older=A, newer=B)
     - Uses load_prompt_template("prompt_diff_LLM") for linguistic analysis
     - Returns: prompt contents, text_diff, linguistic_changes (categorized changes),
       code_diff (if code_path), summary, cost, model, version labels

  8. **Pydantic Models**:
     - Token/Cost: CostEstimateResponse, TokenMetricsResponse
     - Analyze: PromptAnalyzeRequest, PromptAnalyzeResponse
     - Sync: SyncStatusResponse
     - Models: ModelInfo, ModelsResponse
     - Match: MatchCheckRequest, MatchCheckResult, MatchCheckResponse
     - Diff: PromptRange, CodeRange, DiffSection, LineMapping, HiddenKnowledgeLocation,
       HiddenKnowledge, DiffStats, DiffAnalysisResult, DiffAnalysisRequest, DiffAnalysisResponse
     - Git: PromptVersionInfo, PromptHistoryRequest, PromptHistoryResponse,
       LinguisticChange, PromptDiffRequest, PromptDiffResponse

  9. **Error handling**:
     - 403 for SecurityError, 404 for not found, 400 for invalid input
     - 500 for internal errors; preprocessing errors captured in response

  10. **Security**:
      - All file paths validated through PathValidator dependency
      - Change to project_root during preprocessing (for relative includes)

% Dependencies
  <fastapi_example>
    <include>context/fastapi_example.py</include>
  </fastapi_example>

  <server_security_example>
    <include>context/server/security_example.py</include>
  </server_security_example>

  <sync_determine_operation_example>
    <include>context/sync_determine_operation_example.py</include>
  </sync_determine_operation_example>

  <llm_invoke_example>
    <include>context/llm_invoke_example.py</include>
  </llm_invoke_example>

  <load_prompt_template_example>
    <include>context/load_prompt_template_example.py</include>
  </load_prompt_template_example>

  <construct_paths_example>
    <include>context/construct_paths_example.py</include>
  </construct_paths_example>

  <code_generator_main_example>
    <include>context/code_generator_main_example.py</include>
  </code_generator_main_example>

% Instructions
  - Create router with prefix="/api/v1/prompts", tags=["prompts"]
  - Use Depends() for PathValidator injection via get_path_validator()
  - Provide set_path_validator() for configuration
  - Use rich.console.Console for logging (with ImportError fallback)
  - Git operations use subprocess calls (git show, git log, git status)

% Deliverables
  - Code: `pdd/server/routes/prompts.py`
  - Export: router
