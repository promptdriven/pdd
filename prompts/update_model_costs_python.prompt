% You are an expert Python engineer. Your goal is to write a Python script, "update_model_costs.py", that automatically updates the input/output token costs and the structured output support flag in the `data/llm_model.csv` file using data from LiteLLM.

<include>context/python_preamble.prompt</include>

% Script Goal:
    - Read the `llm_model.csv` file using Pandas.
    - Pre-fetch the entire `litellm.model_cost` dictionary for efficiency.
    - For each model listed, check if the 'input' or 'output' cost columns are missing (`pd.isna()`).
    - If costs are missing, retrieve the 'input_cost_per_token' and 'output_cost_per_token' from the pre-fetched LiteLLM data.
    - **Convert** these per-token costs to per-million token costs (cost * 1,000,000) before updating the DataFrame.
    - For each model listed, check if the 'structured_output' column is missing (`pd.isna()`).
    - If needed, determine structured output support using `litellm.supports_response_schema` and update the DataFrame with True/False.
    - Add any missing expected columns (like `max_reasoning_tokens`) with `pd.NA`.
    - **Enforce Data Types:** After loading and adding columns, explicitly cast relevant columns (e.g., `coding_arena_elo`, `max_tokens`, `max_completion_tokens`, `max_reasoning_tokens`) to nullable integers (`'Int64'`).
    - Update the CSV file in place with the fetched/calculated costs and structured output support flags.
    - **Note:** This script does *not* automatically populate the `max_reasoning_tokens` column's values, as this data is not reliably available via LiteLLM. This column needs manual maintenance.

% Inputs:
    - The script should accept the path to the `llm_model.csv` file as a command-line argument (e.g., using `argparse`). Default path should be 'data/llm_model.csv'.
    - Ensure the directory for the CSV path exists, creating it if necessary (`os.makedirs`).
    - **CSV Path Precedence:** The script first checks for the existence of `~/.pdd/llm_model.csv`. If this file exists, it will be used *instead* of the path provided by the `--csv-path` argument. If the user-specific file does not exist, the script proceeds to use the path from the `--csv-path` argument (or its default).

% Core Logic:
    1. Define expected columns including `max_reasoning_tokens`. Define columns intended to be nullable integers.
    2. Load the CSV file into a Pandas DataFrame. Handle potential file not found errors. Check if all expected columns exist; add missing ones with `pd.NA`.
    3. **Enforce Data Types:** Convert columns to their intended types (float, `'Int64'`, object for boolean/NA). Specifically handle `coding_arena_elo` and `max_reasoning_tokens` as `'Int64'`.
    4. **Pre-fetch Costs:** Get the `litellm.model_cost` dictionary. Handle potential errors during fetch.
    5. Iterate through each row of the DataFrame.
    6. Get the LiteLLM model identifier from the 'model' column.
    7. **Initial Model Validation:**
        a. Attempt an initial check using a LiteLLM function (e.g., `litellm.supports_response_schema`) to validate the `model_identifier`.
        b. Handle exceptions (like `ValueError` for unknown models) during this check. If validation fails, mark the row appropriately, report the failure, and **skip subsequent steps for this model**.
        c. If validation succeeds, store the result (e.g., structured output support) for potential later use.
    8. **Check and Update Costs (only if validation passed):**
        a. Check if 'input' or 'output' values are missing (`pd.isna()`).
        b. If missing, look up the model in the pre-fetched cost dictionary.
        c. If found, get 'input_cost_per_token'/'output_cost_per_token'. Handle cases where these keys might be missing.
        d. **Calculate:** Multiply the per-token cost by 1,000,000.
        e. Update the DataFrame cell with the calculated per-million token cost.
        f. **If cost values already exist** in the CSV for the model, compare them to the fetched/calculated LiteLLM values. Report any mismatches found in the console output, but **do not automatically overwrite** the existing CSV values if they differ.
        g. If costs cannot be fetched/calculated, report appropriately.
    9. **Check and Update Structured Output Support (only if validation passed):**
        a. Check if 'structured_output' is missing (`pd.isna()`).
        b. If missing, use the stored result from the initial validation step to update the DataFrame cell with the boolean result (True/False).
        c. If the check fails (e.g., initial validation succeeded but storing failed), report appropriately and leave the cell as `pd.NA` or a default.
    10. **Track Failures:** Implement a reliable method to track models that encountered errors during *any* step (initial validation, cost processing, etc.).
    11. After iterating, save the modified DataFrame back to the CSV file path, overwriting the existing file. Ensure the index is not written and use `na_rep=''` to represent `pd.NA` as empty strings.

% Implementation Details:
    - Use `pandas` for CSV I/O and data manipulation.
    - Use `litellm` for fetching cost data and checking structured output support.
    - Use `argparse` for command-line arguments.
    - Use `os` for directory operations.
    - Use the `rich` library (`Console`, `Table`) to provide clear, formatted console output detailing the update status for each model and a final summary.
    - The summary should include an accurate count of models that had processing errors, based on the failure tracking.
    - Ensure proper error handling for file operations, LiteLLM calls, and data type conversions.

% Here is an example (but not actual values) of the llm_model.csv: <llm_model_example><shell>head -6 data/llm_model.csv</shell></llm_model_example>

% Relevant LiteLLM Documentation:
    - Model Cost Data Structure (illustrative): <litellm_model_cost_example><web>https://docs.litellm.ai/docs/completion/token_usage#8-model_cost</web></litellm_model_cost_example>
    - Check Schema Support: <litellm_supports_schema_example><web>https://docs.litellm.ai/docs/completion/json_mode#2-check-if-model-supports-json_schema</web></litellm_supports_schema_example>
    - Supported Providers/Models (for identifiers): <litellm_providers_list><web>https://docs.litellm.ai/docs/providers</web></litellm_providers_list> 