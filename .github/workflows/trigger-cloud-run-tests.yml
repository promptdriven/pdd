name: Trigger Cloud Run Tests

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string
    secrets:
      GCP_WORKLOAD_IDENTITY_PROVIDER:
        required: true
      GCP_SERVICE_ACCOUNT:
        required: true
      GCP_PROJECT_ID:
        required: true
      GITHUB_TOKEN:
        required: true

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  JOB_NAME: pdd-test-job

jobs:
  trigger-tests:
    name: Execute Tests on Cloud Run
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    permissions:
      contents: read
      id-token: write
      pull-requests: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ inputs.pr_number }}/head
          
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        
      - name: Create Cloud Run Job (if not exists)
        run: |
          # Check if job exists
          if gcloud run jobs describe ${{ env.JOB_NAME }} --region ${{ env.GCP_REGION }} 2>/dev/null; then
            echo "Job already exists"
          else
            echo "Creating Cloud Run Job..."
            gcloud run jobs create ${{ env.JOB_NAME }} \
              --image ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/pdd-images/pdd-test-runner:latest \
              --region ${{ env.GCP_REGION }} \
              --memory 4Gi \
              --cpu 2 \
              --max-retries 0 \
              --task-timeout 3600 \
              --set-secrets "INFISICAL_CLIENT_ID=infisical-client-id:latest,INFISICAL_CLIENT_SECRET=infisical-client-secret:latest" \
              --args test
          fi
          
      - name: Execute Cloud Run Job
        id: execute_job
        run: |
          echo "Executing test job..."
          EXECUTION_NAME=$(gcloud run jobs execute ${{ env.JOB_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --wait \
            --format='value(metadata.name)')
          
          echo "execution_name=$EXECUTION_NAME" >> $GITHUB_OUTPUT
          
      - name: Get job execution logs
        id: get_logs
        if: always()
        run: |
          EXECUTION_NAME="${{ steps.execute_job.outputs.execution_name }}"
          
          # Get logs from Cloud Logging
          gcloud logging read \
            "resource.type=cloud_run_job AND resource.labels.job_name=${{ env.JOB_NAME }} AND resource.labels.location=${{ env.GCP_REGION }}" \
            --limit 1000 \
            --format json > job_logs.json
          
          echo "Logs retrieved"
          
      - name: Parse test results from logs
        id: parse_results
        if: always()
        run: |
          # Extract test results from logs (simplified - you may need to adjust based on actual log format)
          if [ -f job_logs.json ]; then
            # Look for the test summary in logs
            python3 -c "
import json
import sys

try:
    with open('job_logs.json', 'r') as f:
        logs = json.load(f)
    
    # Search for test results in log entries
    results_found = False
    for entry in logs:
        if 'jsonPayload' in entry and 'message' in entry['jsonPayload']:
            message = entry['jsonPayload']['message']
            if 'TEST RUN COMPLETE' in message:
                results_found = True
                print(message)
    
    if not results_found:
        print('Test results not found in logs')
        sys.exit(1)
except Exception as e:
    print(f'Error parsing logs: {e}')
    sys.exit(1)
            "
          else
            echo "No log file found"
          fi
          
      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            let commentBody = '## Cloud Run Test Execution\n\n';
            commentBody += `**Job:** \`${{ env.JOB_NAME }}\`\n`;
            commentBody += `**Execution:** \`${{ steps.execute_job.outputs.execution_name }}\`\n`;
            commentBody += `**Region:** \`${{ env.GCP_REGION }}\`\n\n`;
            
            if ('${{ steps.execute_job.outcome }}' === 'success') {
              commentBody += 'PASS: Tests completed successfully\n\n';
            } else {
              commentBody += 'FAIL: Tests failed or timed out\n\n';
            }
            
            commentBody += '**View logs:**\n';
            commentBody += `[Cloud Run Console](https://console.cloud.google.com/run/jobs/details/${{ env.GCP_REGION }}/${{ env.JOB_NAME }}?project=${{ env.GCP_PROJECT_ID }})\n`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr_number }},
              body: commentBody
            });

