name: Sync from Public Repos
on:
  repository_dispatch:
    types: [sync-from-public]
  workflow_dispatch:
    inputs:
      source:
        description: 'Source repo'
        required: true
        default: 'promptdriven/pdd'
        type: choice
        options:
          - promptdriven/pdd
          - promptdriven/pdd_cap

permissions:
  contents: write
  pull-requests: write

jobs:
  create-sync-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine source repo
        id: source
        run: |
          SOURCE="${{ github.event.client_payload.source || inputs.source || 'promptdriven/pdd' }}"
          echo "repo=$SOURCE" >> $GITHUB_OUTPUT

          if [[ "$SOURCE" == "promptdriven/pdd_cap" ]]; then
            echo "url=https://github.com/promptdriven/pdd_cap.git" >> $GITHUB_OUTPUT
            echo "name=public-cap" >> $GITHUB_OUTPUT
            echo "include_prompts=true" >> $GITHUB_OUTPUT
          else
            echo "url=https://github.com/promptdriven/pdd.git" >> $GITHUB_OUTPUT
            echo "name=public" >> $GITHUB_OUTPUT
            echo "include_prompts=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -e .

      - name: Add remote and fetch
        run: |
          git remote add ${{ steps.source.outputs.name }} ${{ steps.source.outputs.url }} 2>/dev/null || true
          git fetch ${{ steps.source.outputs.name }} main

      - name: Find changed files
        id: changed
        run: |
          REMOTE="${{ steps.source.outputs.name }}"

          # Base patterns (both repos)
          PATTERNS=(
            'pdd/*.py'
            'pdd/commands/*.py'
            'pdd/core/*.py'
            'tests/test_*.py'
            'tests/conftest.py'
            'README.md'
            'requirements.txt'
            'pyproject.toml'
          )

          # Add prompts for pdd_cap
          if [[ "${{ steps.source.outputs.include_prompts }}" == "true" ]]; then
            PATTERNS+=('pdd/prompts/')
          fi

          # Get changed files
          CHANGED=$(git diff --name-only HEAD "$REMOTE/main" -- "${PATTERNS[@]}" 2>/dev/null || echo "")

          if [ -z "$CHANGED" ]; then
            echo "No changes found"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$CHANGED"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "files_b64=$(echo "$CHANGED" | base64 -w0)" >> $GITHUB_OUTPUT
          fi

      - name: Apply changes
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

          REMOTE="${{ steps.source.outputs.name }}"
          SOURCE="${{ steps.source.outputs.repo }}"
          SAFE_SOURCE="${SOURCE//\//-}"

          git checkout -b "sync/from-$SAFE_SOURCE-${{ github.run_id }}"

          echo "${{ steps.changed.outputs.files_b64 }}" | base64 -d | while read -r file; do
            if [ -n "$file" ]; then
              echo "Syncing: $file"
              mkdir -p "$(dirname "$file")"
              git checkout "$REMOTE/main" -- "$file" || echo "Skip: $file"
            fi
          done

      - name: Run tests
        if: steps.changed.outputs.has_changes == 'true'
        continue-on-error: true
        run: |
          pytest tests/test_code_generator_main.py tests/test_commands_modify.py -v --tb=short

      - name: Create PR
        if: steps.changed.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SOURCE="${{ steps.source.outputs.repo }}"
          SAFE_SOURCE="${SOURCE//\//-}"
          FILES=$(echo "${{ steps.changed.outputs.files_b64 }}" | base64 -d)

          git add -A
          git diff --staged --quiet && exit 0

          git commit -m "sync: Import from $SOURCE"
          git push -u origin "sync/from-$SAFE_SOURCE-${{ github.run_id }}"

          gh pr create \
            --title "ðŸ”„ Sync from $SOURCE" \
            --body "$(cat <<EOF
          Automated sync from [$SOURCE](https://github.com/$SOURCE)

          **Commit:** \`${{ github.event.client_payload.sha || 'manual' }}\`

          **Changed files:**
          \`\`\`
          $FILES
          \`\`\`

          âš ï¸ Review carefully before merging.
          EOF
          )" \
            --label "sync"
