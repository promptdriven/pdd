name: Package Install Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-package-install:
    name: Test Package Installation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build package
        run: |
          pip install build
          python -m build

      - name: Install from wheel (not editable)
        run: |
          pip install dist/*.whl

      - name: Test package includes resolve correctly
        run: |
          # Run from /tmp to ensure we only use packaged files
          cd /tmp

          # Create test prompt with _python suffix (required for language detection)
          echo '<include>docs/prompting_guide.md</include>' > test_include_python.prompt

          # Run pdd preprocess CLI
          pdd --quiet preprocess test_include_python.prompt --output preprocessed.txt

          # Verify include was resolved correctly
          # Use 'PDD Mental Model' as marker since the title has special unicode chars
          if grep -q "PDD Mental Model" preprocessed.txt; then
            echo "SUCCESS: Package includes resolved correctly"
          else
            echo "FAILURE: Package include not found or not resolved"
            head -20 preprocessed.txt
            exit 1
          fi
