name: Package Install Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-package-install:
    if: github.event.pull_request.draft != true
    name: Test Package Installation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build package
        run: |
          pip install build
          python -m build

      - name: Install from wheel (not editable)
        run: |
          pip install dist/*.whl

      - name: Test package includes resolve correctly
        run: |
          # Run from /tmp to ensure we only use packaged files
          cd /tmp

          # Create test prompt with _python suffix (required for language detection)
          echo '<include>docs/prompting_guide.md</include>' > test_include_python.prompt

          # Run pdd preprocess CLI
          pdd --quiet preprocess test_include_python.prompt --output preprocessed.txt

          # Verify include was resolved correctly
          # Use 'PDD Mental Model' as marker since the title has special unicode chars
          if grep -q "PDD Mental Model" preprocessed.txt; then
            echo "SUCCESS: Package includes resolved correctly"
          else
            echo "FAILURE: Package include not found or not resolved"
            head -20 preprocessed.txt
            exit 1
          fi

  test-sync:
    if: github.event.pull_request.draft != true
    name: Test PDD Sync
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build and install package
        run: |
          pip install build
          python -m build
          pip install dist/*.whl

      - name: Run pdd sync on hello example
        timeout-minutes: 20
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        working-directory: examples/hello
        run: |
          set -o pipefail  # Ensure pdd exit code propagates through pipe

          # Clean any existing generated files to test fresh generation
          rm -rf src/ tests/ examples/

          # Run sync in local mode with force flag
          # Pipe through tee to log output and trigger non-TTY mode for CI
          pdd --local --force sync hello 2>&1 | tee sync.log

      - name: Verify generated code exists
        working-directory: examples/hello
        run: |
          # Check that src/hello.py was generated
          if [ ! -f "src/hello.py" ]; then
            echo "FAILURE: src/hello.py was not generated"
            exit 1
          fi
          echo "SUCCESS: Generated file exists"
          cat src/hello.py

      - name: Run generated code
        working-directory: examples/hello
        run: |
          # Execute the generated hello.py
          cd src
          OUTPUT=$(python -c "from hello import hello; hello()")

          # Verify output contains "hello"
          if echo "$OUTPUT" | grep -qi "hello"; then
            echo "SUCCESS: Generated code runs correctly"
            echo "Output: $OUTPUT"
          else
            echo "FAILURE: Output did not contain 'hello'"
            echo "Output: $OUTPUT"
            exit 1
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pdd-sync-logs
          path: |
            examples/hello/.pdd/
            examples/hello/src/
            examples/hello/sync.log
          retention-days: 7
