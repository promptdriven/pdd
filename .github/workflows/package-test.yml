name: Package Install Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-package-install:
    name: Test Package Installation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build package
        run: |
          pip install build
          python -m build

      - name: Install from wheel (not editable)
        run: |
          pip install dist/*.whl

      - name: Test package includes resolve correctly
        run: |
          # Run from /tmp to ensure we only use packaged files
          cd /tmp

          # Test include resolution using Python directly
          # This tests the same code path as pdd update/generate
          python -c "
          from pdd.preprocess import preprocess

          result = preprocess('<include>docs/prompting_guide.md</include>')

          # Check that the include resolved (contains content from prompting_guide.md)
          # Use 'PDD Mental Model' as marker since the title has special unicode chars
          if 'PDD Mental Model' in result:
              print('SUCCESS: Package includes resolved correctly')
          else:
              print('FAILURE: Package include not found or not resolved')
              print('First 500 chars:', result[:500])
              exit(1)
          "
