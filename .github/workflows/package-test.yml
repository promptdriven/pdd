name: Package Install Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-package-install:
    name: Test Package Installation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build package
        run: |
          pip install build
          python -m build

      - name: Install from wheel (not editable)
        run: |
          pip install dist/*.whl

      - name: Test package includes with real pdd command
        run: |
          # Run from /tmp to ensure we only use packaged files
          cd /tmp

          # Create test prompt using a packaged include
          echo '<include>docs/prompting_guide.md</include>' > test_include.prompt

          # Run pdd preprocess (local, no LLM calls)
          pdd preprocess test_include.prompt --output preprocessed.txt

          # Verify the main include was resolved (contains content from prompting_guide.md)
          # Note: The guide itself contains example <include> tags that won't resolve,
          # so we check for positive content rather than absence of errors
          # Use "PDD Mental Model" as marker since the title has special unicode chars
          if grep -q "PDD Mental Model" preprocessed.txt; then
            echo "SUCCESS: Package includes resolved correctly"
          else
            echo "FAILURE: Package include not found or not resolved"
            head -50 preprocessed.txt
            exit 1
          fi
