<pdd-reason>Fixes validation errors from a single failed validation step (completeness, sync, or dependencies).</pdd-reason>
<pdd-interface>
{{
  "type": "module",
  "module": {{
    "functions": [
      {{"name": "fix_validation", "signature": "(failed_step: str, failed_output: str)", "returns": "str (list of fixes applied)"}}
    ]
  }}
}}
</pdd-interface>
<pdd-dependency>agentic_arch_step10_deps_LLM.prompt</pdd-dependency>
% You are an expert software architect and PDD configuration specialist. Your task is to fix the validation errors from a failed validation step.

% Context

You are working on step 11 of the agentic architecture workflow. One of the validation steps (8, 9, or 10) failed. Fix the errors and the workflow will re-run validation from step 8.

% Inputs

- GitHub Issue URL: {issue_url}
- Repository: {repo_owner}/{repo_name}
- Issue Number: {issue_number}

% Current Architecture
<architecture_json>
{step6_output}
</architecture_json>

% PRD Summary (for completeness fixes)
<prd_summary>
{step1_output}
</prd_summary>

% Failed Validation Step: {failed_validation_step}

<validation_errors>
{failed_validation_output}
</validation_errors>

% ============================================================================
% FIX BASED ON WHICH STEP FAILED
% ============================================================================

**If failed_validation_step is "completeness" (Step 8):**

Fix architecture completeness issues:

1. **PRD Coverage Gaps:** Add missing modules to architecture.json
   - For each uncovered PRD requirement, create a new module entry
   - Include proper reason, description, dependencies, priority, filename, filepath
   - Create the corresponding prompt file

2. **Missing Layers:** Add essential modules
   - Entry point: Add page/index/main module
   - API routes: Add route modules
   - Types: Add type definition modules
   - Layout: Add layout module

3. **Dependency Graph Issues:**
   - Circular dependencies: Extract shared interface into new module
   - Orphan modules: Connect to dependency graph or verify standalone is OK
   - Missing references: Add referenced module or remove reference

---

**If failed_validation_step is "sync" (Step 9):**

Fix .pddrc sync configuration issues:

1. **Failed pdd sync --dry-run:**
   - "No prompt files found": Create missing prompt file at correct path
   - "Unknown context": Add context to .pddrc or fix context name
   - Verify prompts_dir matches where prompts actually are

2. **Filepath Mismatches:**
   Update .pddrc modules section:
   ```yaml
   modules:
     {basename}:
       filepath: "{exact_filepath_from_architecture}"
       prompts_dir: "{context_prompts_dir}"
   ```

3. **After fixing, verify:**
   ```bash
   pdd sync {basename} --dry-run
   ```

---

**If failed_validation_step is "dependencies" (Step 10):**

Fix prompt dependency issues:

1. **Preprocess Failures:**
   - Missing include files: Create the file or remove the include
   - Invalid paths: Fix the path in the prompt

2. **Missing Includes:**
   - Type/interface file: Create stub or full file
   - Another module's output: Verify module exists
   - External file: Use `<web>` tag instead

3. **False pdd-dependency Declarations:**
   - Remove declarations for non-existent modules
   - Or add missing module to architecture.json and create its prompt

% ============================================================================
% OUTPUT
% ============================================================================

**Step 1: Analyze the specific validation error**

Read the validation output and identify exactly what needs to be fixed.

**Step 2: Apply targeted fixes**

Make ONLY the changes needed to fix this specific validation error:
- `architecture.json` - If modules need to be added/fixed
- `.pddrc` - If sync configuration needs fixing
- Prompt files - If prompts need to be created/fixed

**Step 3: Write corrected files to disk**

```bash
# If architecture.json needs updates
cat > architecture.json << 'EOF'
[
  ... complete JSON array ...
]
EOF

# If .pddrc needs updates
cat > .pddrc << 'EOF'
version: "1.0"
contexts:
  ...
modules:
  ...
EOF

# If prompt files need to be created/fixed
mkdir -p prompts/api prompts/frontend
cat > prompts/path/to/prompt.prompt << 'EOF'
...prompt content...
EOF
```

**Step 4: Verify the fix (for sync errors)**

If fixing sync issues, verify with dry-run:
```bash
pdd sync {basename} --dry-run
```

**Step 5: Post summary to GitHub**

```
gh issue comment {issue_number} --repo {repo_owner}/{repo_name} --body "..."
```

```markdown
## Step 11: Fix Applied

**Failed Step:** {failed_validation_step}
**Iteration:** [N]

### Fixes Applied
1. [Description of fix 1]
2. [Description of fix 2]

### Files Modified/Created
- [file1]: [what changed]
- [file2]: [what changed]

---
*Returning to Step 8 for re-validation*
```

**Step 6: Report ALL files modified**

Output on its own line:
```
FILES_MODIFIED: architecture.json, .pddrc, prompts/api/new_module_TypeScript.prompt, ...
```

% Important

- Focus ONLY on fixing the specific validation error reported
- Don't try to fix issues from other validation steps (they will be checked next)
- Write files directly to disk - don't just output them
- architecture.json must be valid JSON array
- .pddrc must be valid YAML with proper indentation
- Every new module in architecture.json needs a prompt file
- After fixes, workflow will re-run ALL validations from step 8
- Always post findings to GitHub
- Always output `FILES_MODIFIED:` with complete file list
