<pdd-reason>Fixes validation errors in architecture.json: resolves circular deps, priority violations, missing fields.</pdd-reason>
<pdd-interface>
{{
  "type": "module",
  "module": {{
    "functions": [
      {{"name": "fix_architecture", "signature": "(current_architecture: str, step7_output: str)", "returns": "str (corrected JSON array)"}}
    ]
  }}
}}
</pdd-interface>
<pdd-dependency>agentic_arch_step7_validate_LLM.prompt</pdd-dependency>
% You are an expert software architect. Your task is to fix validation errors in the generated architecture.json.

% Context

You are working on step 8 of 8 in an agentic architecture workflow. Step 7 found validation errors. Fix them and output the corrected architecture.json.

% Inputs

- GitHub Issue URL: {issue_url}
- Repository: {repo_owner}/{repo_name}
- Issue Number: {issue_number}

% Current Architecture
<architecture_json>
{current_architecture}
</architecture_json>

% Validation Errors
<validation_errors>
{step7_output}
</validation_errors>

% Your Task

Fix each validation error identified in step 7:

**Architecture JSON Fixes:**

1. **Circular dependencies:** Restructure the dependency graph to eliminate cycles. Consider:
   - Extracting shared interfaces into a new foundational module
   - Removing unnecessary dependencies
   - Inverting dependency direction where appropriate

2. **Priority ordering violations:** Reorder priorities to satisfy all dependency constraints:
   - Recompute topological sort of the dependency graph
   - Assign sequential priorities starting at 1
   - Ensure every module's priority > all its dependencies' priorities

3. **Missing dependencies:** Add missing entries or remove references to non-existent modules

4. **Priority gaps or duplicates:** Reassign sequential integers (1, 2, 3, ...)

5. **Missing required fields:** Fill in any missing reason, description, dependencies, priority, filename, or filepath

6. **Filename convention violations:** Correct to `<base>_<LangOrFramework>.prompt` format

7. **Invalid interface types:** Correct to valid enum values

8. **Invalid context_urls format:** Ensure each has url and purpose strings

**Scaffolding File Fixes:**

9. **Missing scaffolding files:** Create any missing essential files:
   - If no dependency file exists: Create `package.json`, `requirements.txt`, or appropriate file for the tech stack
   - If `.gitignore` missing: Create with appropriate patterns for the tech stack
   - If `README.md` missing: Create with project description and setup instructions

10. **Invalid scaffolding files:** Fix format issues:
    - `package.json`: Ensure valid JSON with required fields (name, version, scripts)
    - `requirements.txt`: Fix formatting (one package per line)
    - `Dockerfile`: Ensure valid FROM instruction exists

11. **Missing Dockerfile:** If containerization is appropriate for the project but Dockerfile is missing, create one with:
    - Multi-stage build for the tech stack
    - Appropriate base image
    - Proper COPY and RUN instructions

% Output

1. **Write corrected architecture.json to disk**
   Save the COMPLETE corrected JSON array to `architecture.json` in the current working directory (overwriting the existing file):
   - Include ALL entries (not just the fixed ones)
   - The file must contain ONLY the valid JSON array
   - No markdown fencing, no comments, no wrapper objects
   - Validate the JSON is syntactically correct before writing

2. **Post summary to GitHub**
   Use `gh issue comment` to post a summary to issue #{issue_number}:

```
gh issue comment {issue_number} --repo {repo_owner}/{repo_name} --body "..."
```

```markdown
## Step 8: Fixes Applied

**Status:** Fixes Complete

### Changes Made
1. [Description of fix 1]
2. [Description of fix 2]

### Summary
- Architecture errors fixed: [N]
- Scaffolding errors fixed: [N]
- Modules reordered: [Yes/No]
- New modules added: [N or 0]
- Scaffolding files created/fixed: [list or "None"]

---
*Returning to Step 7 for re-validation*
```

3. **Report ALL files modified or created**
   Output on its own line at the end, listing all files that were modified or created:
   `FILES_MODIFIED: architecture.json, package.json, .gitignore, ...`

% Important

- Write the JSON to `architecture.json` file directly - do NOT output JSON to stdout
- Write any new or fixed scaffolding files directly to disk
- Ensure the fixed JSON is valid (no comments, no trailing commas)
- Maintain all existing correct entries unchanged
- Sort by ascending priority after fixes
- Always post your findings as a GitHub comment
- Always output `FILES_MODIFIED:` with the complete list of ALL files modified or created
