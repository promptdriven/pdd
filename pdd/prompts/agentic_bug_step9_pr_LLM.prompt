% You are an expert software engineer investigating a bug report. Your task is to create a draft pull request with the failing test and link it to the issue.

% Context

You are working on step 9 of 9 (final step) in an agentic bug investigation workflow. Previous steps have generated and verified a failing test that detects the bug.

% Inputs

- GitHub Issue URL: {issue_url}
- Repository: {repo_owner}/{repo_name}
- Issue Number: {issue_number}

% Issue Content
<issue_content>
{issue_content}
</issue_content>

% Previous Steps Output
<step1_output>
{step1_output}
</step1_output>

<step2_output>
{step2_output}
</step2_output>

<step3_output>
{step3_output}
</step3_output>

<step4_output>
{step4_output}
</step4_output>

<step5_output>
{step5_output}
</step5_output>

<step6_output>
{step6_output}
</step6_output>

<step7_output>
{step7_output}
</step7_output>

<step8_output>
{step8_output}
</step8_output>

% Worktree Information

You are operating in an isolated git worktree at: {worktree_path}
This worktree is already checked out to branch `fix/issue-{issue_number}`.
Do NOT create a new branch - just stage, commit, and push.

% Files to Stage

**IMPORTANT: Only stage these specific files:**
{files_to_stage}

% Your Task

1. **Prepare the commit**
   - You are already on branch `fix/issue-{issue_number}` in an isolated worktree
   - **CRITICAL: Stage ONLY the test file(s) created in Step 7**
   - Get the exact file paths from Step 7's `FILES_CREATED:` or `FILES_MODIFIED:` output in the `<step7_output>` section above
   - Stage each file individually: `git add <exact_file_path>`
   - **DO NOT use `git add .` or `git add -A`** - these will stage unrelated files and pollute the PR
   - Verify only the intended files are staged: `git status --short` (should show only the test file(s))
   - Commit with a descriptive message referencing the issue

2. **Create the draft PR**
   - Push the branch to origin
   - Create a draft pull request using `gh pr create --draft`
   - Link to the issue using "Fixes #{issue_number}" in the PR body

3. **Post final summary**
   - Comment on the issue with PR link and next steps for the fix

4. **Include PDD fix command**
   - Extract code file path from Step 5's `**Location:**` field (strip the `:line_number` suffix)
   - Use test file path from Step 7's `FILES_CREATED:` or test file section
   - Search repo for matching prompt file: `find . -name "*.prompt" -type f`
   - Derive module name from code file (e.g., `pdd/foo.py` â†’ `foo`)
   - Use verification program: `context/{{module_name}}_example.py`
   - Use error log path: `fix-issue-{issue_number}.log` for the fix command output
   - Include a ready-to-run `pdd fix` command in your GitHub comment
   - If no prompt file or verification program exists, include a note that they must be created first

% PR Creation Command

```bash
gh pr create --draft --title "Add failing test for #{issue_number}" --body "$(cat <<'EOF'
## Summary
Adds a failing test that detects the bug reported in #{issue_number}.

## Test File
`{{test_file_path}}`

## What This PR Contains
- Failing unit test that reproduces the reported bug
- Test is verified to fail on current code and will pass once the bug is fixed

## Root Cause
{{root_cause_summary}}

## Next Steps
1. [ ] Implement the fix at the identified location
2. [ ] Verify the test passes
3. [ ] Run full test suite
4. [ ] Mark PR as ready for review

Fixes #{issue_number}

---
*Generated by PDD agentic bug workflow*
EOF
)"
```

% Output

After creating the PR, use `gh issue comment` to post your final report to issue #{issue_number}:

```
gh issue comment {issue_number} --repo {repo_owner}/{repo_name} --body "..."
```

Your comment should follow this format:

```markdown
## Step 9: Draft PR Created

### Pull Request
**PR #{{pr_number}}:** [{{pr_title}}]({{pr_url}})

### Branch
`fix/issue-{issue_number}`

### What's Included
- Failing test at `{{test_file_path}}`
- Commits: {{commit_count}}

### Next Steps for Maintainers
1. Review the failing test to understand the expected behavior
2. Implement the fix at the identified location
3. Verify the test passes with your fix
4. Run full test suite to check for regressions
5. Mark the PR as ready for review

### PDD Fix Command

To auto-fix this bug using PDD:

```bash
cd {{worktree_path}}
pdd --force fix --loop --max-attempts 5 --verification-program context/{{module_name}}_example.py {{prompt_file}} {{code_file_path}} {{test_file_path}} fix-issue-{{issue_number}}.log
```

---
*Investigation complete. A draft PR with a failing test has been created and linked to this issue.*
```

% Important

- Create a DRAFT PR (not ready for review) since it only contains the failing test
- The PR should clearly state that a fix is still needed
- Use "Fixes #{issue_number}" to auto-link the PR to the issue
- Do NOT create a new branch - you are already on the correct branch in the worktree
- Always post your findings as a GitHub comment before completing
