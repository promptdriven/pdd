# Makefile.test-staging - Staging E2E Testing for PDD Cloud Commands
#
# Supports testing all PDD cloud commands: generate, test, example, fix, bug, crash, verify
#
# Usage:
#   make -f Makefile.test-staging help          # Show all targets
#   make -f Makefile.test-staging token         # Get fresh JWT token
#   make -f Makefile.test-staging test-api      # Test generateTest API endpoint
#   make -f Makefile.test-staging test-api-generate  # Test generateCode API endpoint
#   make -f Makefile.test-staging test-api-example   # Test generateExample API endpoint
#   make -f Makefile.test-staging test-api-fix       # Test fixCode API endpoint
#   make -f Makefile.test-staging test-api-bug       # Test generateBugTest API endpoint
#   make -f Makefile.test-staging test-cli      # Test pdd test CLI command
#   make -f Makefile.test-staging test-cli-generate  # Test pdd generate CLI command
#   make -f Makefile.test-staging test-cli-example   # Test pdd example CLI command
#   make -f Makefile.test-staging test-cli-fix       # Test pdd fix CLI command
#   make -f Makefile.test-staging test-cli-bug       # Test pdd bug CLI command
#   make -f Makefile.test-staging full-test     # Run all tests
#   make -f Makefile.test-staging quick-test    # Run API-only tests (faster)
#
# Prerequisites:
#   - Python 3 with urllib available
#   - Local pdd codebase at /Users/caijiamin/Desktop/PDD_PRIVATE/pdd

.PHONY: help token check-token show-user balance \
        test-api test-api-generate test-api-example test-api-fix test-api-bug test-api-crash test-api-verify test-api-examples \
        test-examples-content test-examples-by-language test-logs test-examples-e2e \
        test-cli test-cli-generate test-cli-example test-cli-fix test-cli-fix-loop test-cli-bug test-cli-crash test-cli-crash-loop test-cli-verify \
        test-cli-comprehensive test-cli-with-logs \
        full-test quick-test clean show-env \
        create-test-files create-generate-files create-example-files create-fix-files create-bug-files create-crash-files create-verify-files

# ============================================================================
# Configuration
# ============================================================================
STAGING_API_KEY := AIzaSyC7rX6OLGVDlzkU8q7nK_i14ggOqjNz2N4
STAGING_EMAIL := staging-cli-test@pdd-staging.com
STAGING_PASSWORD := StagingCLI_Test_2024!
STAGING_CLOUD_URL := https://us-central1-prompt-driven-development-stg.cloudfunctions.net
TOKEN_FILE := /tmp/pdd_staging_token.txt
RESPONSE_FILE := /tmp/pdd_test_response.json
GENERATE_RESPONSE_FILE := /tmp/pdd_generate_response.json
EXAMPLE_RESPONSE_FILE := /tmp/pdd_example_response.json
FIX_RESPONSE_FILE := /tmp/pdd_fix_response.json

# GCloud log configuration
GCP_PROJECT_ID := prompt-driven-development-stg
LOG_WINDOW_MINUTES := 30
LOG_RESPONSE_FILE := /tmp/pdd_gcloud_logs.json
EXAMPLES_RESPONSE_FILE := /tmp/pdd_examples_response.json

# Local PDD path (avoids globally installed pdd)
# Use explicit path to pdd project directory
PDD_LOCAL_DIR := /Users/caijiamin/Desktop/PDD_PRIVATE/pdd
PYTHONPATH_LOCAL := PYTHONPATH=$(PDD_LOCAL_DIR):$$PYTHONPATH

# Test files - Common
TEST_PROMPT_DIR := /tmp/pdd_test_staging
TEST_PROMPT_FILE := $(TEST_PROMPT_DIR)/prompts/test_factorial.prompt
TEST_CODE_FILE := $(TEST_PROMPT_DIR)/src/factorial.py
TEST_OUTPUT_FILE := $(TEST_PROMPT_DIR)/tests/test_factorial_generated.py

# Test files - Generate command
GENERATE_PROMPT_FILE := $(TEST_PROMPT_DIR)/prompts/sum_python.prompt
GENERATE_OUTPUT_FILE := $(TEST_PROMPT_DIR)/src/sum_generated.py

# Test files - Example command
EXAMPLE_PROMPT_FILE := $(TEST_PROMPT_DIR)/prompts/example_multiply.prompt
EXAMPLE_CODE_FILE := $(TEST_PROMPT_DIR)/src/multiply.py
EXAMPLE_OUTPUT_FILE := $(TEST_PROMPT_DIR)/examples/multiply_example.py

# Test files - Fix command
FIX_PROMPT_FILE := $(TEST_PROMPT_DIR)/prompts/fix_divide.prompt
FIX_CODE_FILE := $(TEST_PROMPT_DIR)/src/divide.py
FIX_TEST_FILE := $(TEST_PROMPT_DIR)/tests/test_divide.py
FIX_ERROR_FILE := $(TEST_PROMPT_DIR)/errors/divide_errors.txt
FIX_OUTPUT_CODE := $(TEST_PROMPT_DIR)/src/divide_fixed.py
FIX_OUTPUT_TEST := $(TEST_PROMPT_DIR)/tests/test_divide_fixed.py

# Test files - Crash command
CRASH_PROMPT_FILE := $(TEST_PROMPT_DIR)/prompts/crash_multiply.prompt
CRASH_CODE_FILE := $(TEST_PROMPT_DIR)/src/crash_multiply.py
CRASH_PROGRAM_FILE := $(TEST_PROMPT_DIR)/scripts/run_multiply.py
CRASH_ERROR_FILE := $(TEST_PROMPT_DIR)/errors/multiply_crash.txt
CRASH_OUTPUT_CODE := $(TEST_PROMPT_DIR)/src/crash_multiply_fixed.py
CRASH_OUTPUT_PROGRAM := $(TEST_PROMPT_DIR)/scripts/run_multiply_fixed.py

# Test files - Verify command
VERIFY_PROMPT_FILE := $(TEST_PROMPT_DIR)/prompts/verify_add.prompt
VERIFY_CODE_FILE := $(TEST_PROMPT_DIR)/src/verify_add.py
VERIFY_PROGRAM_FILE := $(TEST_PROMPT_DIR)/scripts/run_add.py
VERIFY_OUTPUT_CODE := $(TEST_PROMPT_DIR)/src/verify_add_verified.py
VERIFY_OUTPUT_PROGRAM := $(TEST_PROMPT_DIR)/scripts/run_add_verified.py

# Test files - Bug command
BUG_PROMPT_FILE := $(TEST_PROMPT_DIR)/prompts/bug_add.prompt
BUG_CODE_FILE := $(TEST_PROMPT_DIR)/src/bug_add.py
BUG_PROGRAM_FILE := $(TEST_PROMPT_DIR)/scripts/run_bug_add.py
BUG_CURRENT_OUTPUT_FILE := $(TEST_PROMPT_DIR)/outputs/bug_current_output.txt
BUG_DESIRED_OUTPUT_FILE := $(TEST_PROMPT_DIR)/outputs/bug_desired_output.txt
BUG_OUTPUT_TEST := $(TEST_PROMPT_DIR)/tests/test_bug_add_generated.py
BUG_RESPONSE_FILE := /tmp/pdd_bug_response.json

# Colors for output
GREEN := \033[0;32m
YELLOW := \033[0;33m
RED := \033[0;31m
BLUE := \033[0;34m
NC := \033[0m

# ============================================================================
# Help
# ============================================================================
help:
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  PDD Test Command - Staging E2E Test Makefile$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@echo "$(GREEN)Token Management:$(NC)"
	@echo "  make -f Makefile.test-staging token        - Get fresh JWT token"
	@echo "  make -f Makefile.test-staging check-token  - Verify token is valid"
	@echo "  make -f Makefile.test-staging show-user    - Show user info from token"
	@echo ""
	@echo "$(GREEN)API Tests (Direct curl):$(NC)"
	@echo "  make -f Makefile.test-staging test-api          - Test generateTest endpoint"
	@echo "  make -f Makefile.test-staging test-api-generate - Test generateCode endpoint"
	@echo "  make -f Makefile.test-staging test-api-example  - Test generateExample endpoint"
	@echo "  make -f Makefile.test-staging test-api-fix      - Test fixCode endpoint"
	@echo "  make -f Makefile.test-staging test-api-bug      - Test generateBugTest endpoint"
	@echo "  make -f Makefile.test-staging test-api-crash    - Test crashCode endpoint"
	@echo "  make -f Makefile.test-staging test-api-verify   - Test verifyCode endpoint"
	@echo "  make -f Makefile.test-staging test-api-examples - Check few-shot examples availability"
	@echo "  make -f Makefile.test-staging balance           - Check credit balance"
	@echo ""
	@echo "$(GREEN)Example Validation Tests:$(NC)"
	@echo "  make -f Makefile.test-staging test-examples-content     - Validate example content structure"
	@echo "  make -f Makefile.test-staging test-examples-by-language - Test examples for python/typescript"
	@echo "  make -f Makefile.test-staging test-examples-e2e         - Full e2e test with log verification"
	@echo ""
	@echo "$(GREEN)GCloud Log Tests:$(NC)"
	@echo "  make -f Makefile.test-staging test-logs    - Query GCloud logs for example retrieval"
	@echo ""
	@echo "$(GREEN)CLI Tests:$(NC)"
	@echo "  make -f Makefile.test-staging test-cli           - Test 'pdd test' command with cloud"
	@echo "  make -f Makefile.test-staging test-cli-generate  - Test 'pdd generate' command with cloud"
	@echo "  make -f Makefile.test-staging test-cli-example   - Test 'pdd example' command with cloud"
	@echo "  make -f Makefile.test-staging test-cli-fix       - Test 'pdd fix' command with cloud"
	@echo "  make -f Makefile.test-staging test-cli-fix-loop  - Test 'pdd fix --loop' command with cloud"
	@echo "  make -f Makefile.test-staging test-cli-bug       - Test 'pdd bug' command with cloud"
	@echo "  make -f Makefile.test-staging test-cli-crash     - Test 'pdd crash' command with cloud"
	@echo "  make -f Makefile.test-staging test-cli-crash-loop- Test 'pdd crash --loop' command with cloud"
	@echo "  make -f Makefile.test-staging test-cli-verify    - Test 'pdd verify' command with cloud"
	@echo ""
	@echo "$(GREEN)Comprehensive CLI Tests:$(NC)"
	@echo "  make -f Makefile.test-staging test-cli-comprehensive - Run all CLI command variants"
	@echo "  make -f Makefile.test-staging test-cli-with-logs     - Run CLI tests + verify GCloud logs"
	@echo ""
	@echo "$(GREEN)Full Test Suite:$(NC)"
	@echo "  make -f Makefile.test-staging full-test    - Run complete e2e test suite (all commands)"
	@echo "  make -f Makefile.test-staging quick-test   - Run quick API-only test suite"
	@echo ""
	@echo "$(GREEN)Utilities:$(NC)"
	@echo "  make -f Makefile.test-staging create-test-files - Create test prompt/code files"
	@echo "  make -f Makefile.test-staging clean             - Remove generated files"
	@echo ""
	@echo "$(GREEN)Shortcuts:$(NC)"
	@echo "  make -f Makefile.test-staging t    - token"
	@echo "  make -f Makefile.test-staging u    - show-user"
	@echo "  make -f Makefile.test-staging b    - balance"
	@echo "  make -f Makefile.test-staging a    - test-api (generateTest)"
	@echo "  make -f Makefile.test-staging ag   - test-api-generate"
	@echo "  make -f Makefile.test-staging ae   - test-api-example"
	@echo "  make -f Makefile.test-staging af   - test-api-fix"
	@echo "  make -f Makefile.test-staging ab   - test-api-bug"
	@echo "  make -f Makefile.test-staging e    - test-api-examples"
	@echo "  make -f Makefile.test-staging c    - test-cli (test command)"
	@echo "  make -f Makefile.test-staging cg   - test-cli-generate"
	@echo "  make -f Makefile.test-staging ce   - test-cli-example"
	@echo "  make -f Makefile.test-staging cf   - test-cli-fix"
	@echo "  make -f Makefile.test-staging cfl  - test-cli-fix-loop"
	@echo "  make -f Makefile.test-staging cb   - test-cli-bug"
	@echo "  make -f Makefile.test-staging ccr  - test-cli-crash"
	@echo "  make -f Makefile.test-staging ccrl - test-cli-crash-loop"
	@echo "  make -f Makefile.test-staging cv   - test-cli-verify"
	@echo "  make -f Makefile.test-staging cc   - test-cli-comprehensive"
	@echo "  make -f Makefile.test-staging cwl  - test-cli-with-logs"
	@echo "  make -f Makefile.test-staging f    - full-test"
	@echo "  make -f Makefile.test-staging ec   - test-examples-content"
	@echo "  make -f Makefile.test-staging el   - test-examples-by-language"
	@echo "  make -f Makefile.test-staging l    - test-logs"
	@echo "  make -f Makefile.test-staging ee   - test-examples-e2e"
	@echo ""
	@echo "$(YELLOW)Note: Tokens expire after 1 hour. Run 'make token' to refresh.$(NC)"
	@echo "$(YELLOW)Note: GCloud log tests require 'gcloud' CLI and access to $(GCP_PROJECT_ID).$(NC)"
	@echo ""

# ============================================================================
# Token Management
# ============================================================================
token:
	@echo "$(BLUE)Getting fresh staging JWT token...$(NC)"
	@python3 -c "import urllib.request, json, sys; \
		url='https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=$(STAGING_API_KEY)'; \
		payload={'email':'$(STAGING_EMAIL)','password':'$(STAGING_PASSWORD)','returnSecureToken':True}; \
		req=urllib.request.Request(url,json.dumps(payload).encode(),{'Content-Type':'application/json'}); \
		resp=urllib.request.urlopen(req,timeout=15); \
		token=json.loads(resp.read())['idToken']; \
		print(token,end='')" > $(TOKEN_FILE)
	@echo ""
	@echo "$(GREEN)Token saved to $(TOKEN_FILE)$(NC)"
	@echo "Token length: $$(wc -c < $(TOKEN_FILE)) bytes"
	@echo ""
	@echo "$(YELLOW)To use in your shell:$(NC)"
	@echo "  export PDD_JWT_TOKEN=\$$(cat $(TOKEN_FILE))"
	@echo "  export PDD_CLOUD_URL=$(STAGING_CLOUD_URL)"

check-token:
	@if [ ! -f $(TOKEN_FILE) ]; then \
		echo "$(RED)No token file found. Run 'make -f Makefile.test-staging token' first.$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)Checking token validity...$(NC)"
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' \
		-o /tmp/pdd_check_response.json; \
	if grep -q "credits" /tmp/pdd_check_response.json; then \
		echo "$(GREEN)Token is valid!$(NC)"; \
		python3 -c "import json; d=json.load(open('/tmp/pdd_check_response.json')); print(f'Balance: {d.get(\"credits\", \"?\")} PDDC')"; \
	else \
		echo "$(RED)Token is invalid or expired.$(NC)"; \
		cat /tmp/pdd_check_response.json; \
		echo "$(YELLOW)Run 'make -f Makefile.test-staging token' to get a new token.$(NC)"; \
		exit 1; \
	fi

show-user:
	@if [ ! -f $(TOKEN_FILE) ]; then \
		echo "$(RED)No token file found. Run 'make -f Makefile.test-staging token' first.$(NC)"; \
		exit 1; \
	fi
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	python3 -c "import base64,json; \
		token='$$TOKEN'.split('.')[1]; \
		padding='=' * (4 - len(token) % 4); \
		payload=json.loads(base64.urlsafe_b64decode(token + padding)); \
		print('Email:', payload.get('email', 'unknown')); \
		print('User ID:', payload.get('user_id', payload.get('sub', 'unknown'))); \
		import time; exp=payload.get('exp',0); \
		remaining=exp-int(time.time()); \
		print(f'Token expires in: {remaining//60} minutes')"

# ============================================================================
# API Tests
# ============================================================================
balance: check-token
	@echo ""
	@echo "$(BLUE)Checking credit balance...$(NC)"
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' \
		-o /tmp/pdd_balance_response.json; \
	python3 -c "import json; d=json.load(open('/tmp/pdd_balance_response.json')); \
		print(f'Balance: {d.get(\"credits\", \"?\")} PDDC')"

test-api: check-token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing generateTest API endpoint$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Sending request to generateTest...$(NC)"; \
	curl -s -X POST "$(STAGING_CLOUD_URL)/generateTest" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"promptContent": "Write a function to calculate factorial", "codeContent": "def factorial(n):\n    if n <= 1:\n        return 1\n    return n * factorial(n - 1)", "language": "python", "mode": "generate", "strength": 0.75, "temperature": 0.0, "verbose": true}' \
		-o $(RESPONSE_FILE); \
	echo ""; \
	echo "$(GREEN)Response Summary:$(NC)"; \
	python3 -c "import json; d=json.load(open('$(RESPONSE_FILE)')); print('  Credits Deducted:', d.get('creditsDeducted', '?')); print('  New Balance:', d.get('newBalance', '?'), 'PDDC'); print('  Total Cost: \$$' + str(round(d.get('totalCost', 0), 6))); print('  Model:', d.get('modelName', 'unknown')); print('  Generated Test Length:', len(d.get('generatedTest', '')), 'chars')"; \
	echo ""; \
	if grep -q "generatedTest" $(RESPONSE_FILE); then \
		echo "$(GREEN)API test PASSED$(NC)"; \
		echo ""; \
		echo "$(BLUE)Generated Test Preview (first 500 chars):$(NC)"; \
		python3 -c "import json; d=json.load(open('$(RESPONSE_FILE)')); print(d.get('generatedTest', '')[:500])"; \
	else \
		echo "$(RED)API test FAILED$(NC)"; \
		cat $(RESPONSE_FILE); \
		exit 1; \
	fi

test-api-generate: check-token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing generateCode API endpoint$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Sending request to generateCode...$(NC)"; \
	curl -s -X POST "$(STAGING_CLOUD_URL)/generateCode" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"promptContent": "Write a Python function called sum_numbers that takes a list of numbers and returns their sum. Handle empty lists by returning 0.", "language": "python", "mode": "generate", "strength": 0.75, "temperature": 0.0, "verbose": true}' \
		-o $(GENERATE_RESPONSE_FILE); \
	echo ""; \
	echo "$(GREEN)Response Summary:$(NC)"; \
	python3 -c "import json; d=json.load(open('$(GENERATE_RESPONSE_FILE)')); print('  Credits Deducted:', d.get('creditsDeducted', '?')); print('  New Balance:', d.get('newBalance', '?'), 'PDDC'); print('  Total Cost: \$$' + str(round(d.get('totalCost', 0), 6))); print('  Model:', d.get('modelName', 'unknown')); print('  Generated Code Length:', len(d.get('generatedCode', '')), 'chars')"; \
	echo ""; \
	if grep -q "generatedCode" $(GENERATE_RESPONSE_FILE); then \
		echo "$(GREEN)API generateCode test PASSED$(NC)"; \
		echo ""; \
		echo "$(BLUE)Generated Code Preview (first 500 chars):$(NC)"; \
		python3 -c "import json; d=json.load(open('$(GENERATE_RESPONSE_FILE)')); print(d.get('generatedCode', '')[:500])"; \
	else \
		echo "$(RED)API generateCode test FAILED$(NC)"; \
		cat $(GENERATE_RESPONSE_FILE); \
		exit 1; \
	fi

test-api-example: check-token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing generateExample API endpoint$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Sending request to generateExample...$(NC)"; \
	curl -s -X POST "$(STAGING_CLOUD_URL)/generateExample" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"promptContent": "Write a function to multiply two numbers", "codeContent": "def multiply(a, b):\n    \"\"\"Multiply two numbers together.\"\"\"\n    return a * b", "language": "python", "mode": "generate", "strength": 0.75, "temperature": 0.0, "verbose": true}' \
		-o $(EXAMPLE_RESPONSE_FILE); \
	echo ""; \
	echo "$(GREEN)Response Summary:$(NC)"; \
	python3 -c "import json; d=json.load(open('$(EXAMPLE_RESPONSE_FILE)')); print('  Credits Deducted:', d.get('creditsDeducted', '?')); print('  New Balance:', d.get('newBalance', '?'), 'PDDC'); print('  Total Cost: \$$' + str(round(d.get('totalCost', 0), 6))); print('  Model:', d.get('modelName', 'unknown')); print('  Generated Example Length:', len(d.get('generatedExample', '')), 'chars')"; \
	echo ""; \
	if grep -q "generatedExample" $(EXAMPLE_RESPONSE_FILE); then \
		echo "$(GREEN)API generateExample test PASSED$(NC)"; \
		echo ""; \
		echo "$(BLUE)Generated Example Preview (first 500 chars):$(NC)"; \
		python3 -c "import json; d=json.load(open('$(EXAMPLE_RESPONSE_FILE)')); print(d.get('generatedExample', '')[:500])"; \
	else \
		echo "$(RED)API generateExample test FAILED$(NC)"; \
		cat $(EXAMPLE_RESPONSE_FILE); \
		exit 1; \
	fi

test-api-fix: check-token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing fixCode API endpoint$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Sending request to fixCode...$(NC)"; \
	curl -s -X POST "$(STAGING_CLOUD_URL)/fixCode" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"prompt": "Write a function to safely divide two numbers", "code": "def divide(a, b):\n    return a / b", "unitTest": "def test_divide():\n    assert divide(10, 2) == 5\n    assert divide(10, 0) == 0  # Should handle division by zero", "errors": "ZeroDivisionError: division by zero", "language": "python", "mode": "fix", "strength": 0.75, "temperature": 0.0, "verbose": true}' \
		-o $(FIX_RESPONSE_FILE); \
	echo ""; \
	echo "$(GREEN)Response Summary:$(NC)"; \
	python3 -c "import json; d=json.load(open('$(FIX_RESPONSE_FILE)')); print('  Credits Deducted:', d.get('creditsDeducted', '?')); print('  New Balance:', d.get('newBalance', '?'), 'PDDC'); print('  Total Cost: \$$' + str(round(d.get('totalCost', 0), 6))); print('  Model:', d.get('modelName', 'unknown')); print('  Fixed Code Length:', len(d.get('fixedCode', '')), 'chars'); print('  Fixed Test Length:', len(d.get('fixedUnitTest', '')), 'chars')"; \
	echo ""; \
	if grep -q "fixedCode" $(FIX_RESPONSE_FILE) || grep -q "fixedUnitTest" $(FIX_RESPONSE_FILE); then \
		echo "$(GREEN)API fixCode test PASSED$(NC)"; \
		echo ""; \
		echo "$(BLUE)Fixed Code Preview (first 500 chars):$(NC)"; \
		python3 -c "import json; d=json.load(open('$(FIX_RESPONSE_FILE)')); print(d.get('fixedCode', d.get('fixedUnitTest', ''))[:500])"; \
	else \
		echo "$(RED)API fixCode test FAILED$(NC)"; \
		cat $(FIX_RESPONSE_FILE); \
		exit 1; \
	fi

# Response files for crash and verify
CRASH_RESPONSE_FILE := /tmp/pdd_crash_response.json
VERIFY_RESPONSE_FILE := /tmp/pdd_verify_response.json

test-api-crash: check-token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing crashCode API endpoint$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Sending request to crashCode...$(NC)"; \
	curl -s -X POST "$(STAGING_CLOUD_URL)/crashCode" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"promptContent": "Write a function to multiply a number by two", "codeContent": "def multiply_by_two(x):\n    return x * 2", "programContent": "from multiply import multiply_by_two\nresult = multiply_by_two(\"5\")\nprint(result)", "errorContent": "TypeError: cannot multiply sequence by non-int of type str", "language": "python", "strength": 0.5, "temperature": 0.0, "verbose": true}' \
		-o $(CRASH_RESPONSE_FILE); \
	echo ""; \
	echo "$(GREEN)Response Summary:$(NC)"; \
	python3 -c "import json; d=json.load(open('$(CRASH_RESPONSE_FILE)')); print('  Credits Deducted:', d.get('creditsDeducted', '?')); print('  New Balance:', d.get('newBalance', '?'), 'PDDC'); print('  Total Cost: \$$' + str(round(d.get('totalCost', 0), 6))); print('  Model:', d.get('modelName', 'unknown')); print('  Update Code:', d.get('updateCode', '?')); print('  Update Program:', d.get('updateProgram', '?')); print('  Fixed Code Length:', len(d.get('fixedCode', '')), 'chars')"; \
	echo ""; \
	if grep -q "fixedCode" $(CRASH_RESPONSE_FILE) || grep -q "fixedProgram" $(CRASH_RESPONSE_FILE); then \
		echo "$(GREEN)API crashCode test PASSED$(NC)"; \
		echo ""; \
		echo "$(BLUE)Fixed Code Preview (first 500 chars):$(NC)"; \
		python3 -c "import json; d=json.load(open('$(CRASH_RESPONSE_FILE)')); print(d.get('fixedCode', '')[:500])"; \
		echo ""; \
		echo "$(BLUE)Analysis:$(NC)"; \
		python3 -c "import json; d=json.load(open('$(CRASH_RESPONSE_FILE)')); print(d.get('analysis', '')[:500])"; \
	else \
		echo "$(RED)API crashCode test FAILED$(NC)"; \
		cat $(CRASH_RESPONSE_FILE); \
		exit 1; \
	fi

test-api-verify: check-token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing verifyCode API endpoint$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Sending request to verifyCode...$(NC)"; \
	curl -s -X POST "$(STAGING_CLOUD_URL)/verifyCode" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"promptContent": "Write a function to add two numbers", "codeContent": "def add(a, b):\n    return a + b", "programContent": "from add import add\nresult = add(2, 3)\nprint(f\"Result: {result}\")", "outputContent": "Result: 5", "language": "python", "strength": 0.5, "temperature": 0.0, "verbose": true}' \
		-o $(VERIFY_RESPONSE_FILE); \
	echo ""; \
	echo "$(GREEN)Response Summary:$(NC)"; \
	python3 -c "import json; d=json.load(open('$(VERIFY_RESPONSE_FILE)')); print('  Credits Deducted:', d.get('creditsDeducted', '?')); print('  New Balance:', d.get('newBalance', '?'), 'PDDC'); print('  Total Cost: \$$' + str(round(d.get('totalCost', 0), 6))); print('  Model:', d.get('modelName', 'unknown')); print('  Issues Count:', d.get('issuesCount', '?')); print('  Fixed Code Length:', len(d.get('fixedCode', '')), 'chars')"; \
	echo ""; \
	if grep -q "fixedCode" $(VERIFY_RESPONSE_FILE) || grep -q "explanation" $(VERIFY_RESPONSE_FILE); then \
		echo "$(GREEN)API verifyCode test PASSED$(NC)"; \
		echo ""; \
		echo "$(BLUE)Issues Count:$(NC)"; \
		python3 -c "import json; d=json.load(open('$(VERIFY_RESPONSE_FILE)')); print('  Issues:', d.get('issuesCount', 0)); e=d.get('explanation'); print('  Explanation:', (e[:300]+'...' if e and len(e)>300 else e) if e else 'None (no issues found)')"; \
	else \
		echo "$(RED)API verifyCode test FAILED$(NC)"; \
		cat $(VERIFY_RESPONSE_FILE); \
		exit 1; \
	fi

test-api-bug: check-token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing generateBugTest API endpoint$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Sending request to generateBugTest...$(NC)"; \
	curl -s -X POST "$(STAGING_CLOUD_URL)/generateBugTest" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"promptContent": "Write a function to add two numbers", "codeContent": "def add(a, b):\n    return a - b  # Bug: should be +", "programContent": "result = add(2, 3)\nprint(result)", "currentOutput": "-1", "desiredOutput": "5", "language": "python", "strength": 0.5, "temperature": 0.0, "verbose": true}' \
		-o $(BUG_RESPONSE_FILE); \
	echo ""; \
	echo "$(GREEN)Response Summary:$(NC)"; \
	python3 -c "import json; d=json.load(open('$(BUG_RESPONSE_FILE)')); print('  Credits Deducted:', d.get('creditsDeducted', '?')); print('  New Balance:', d.get('newBalance', '?'), 'PDDC'); print('  Total Cost: \$$' + str(round(d.get('totalCost', 0), 6))); print('  Model:', d.get('modelName', 'unknown')); print('  Generated Test Length:', len(d.get('generatedTest', '')), 'chars')"; \
	echo ""; \
	if grep -q "generatedTest" $(BUG_RESPONSE_FILE); then \
		echo "$(GREEN)API generateBugTest test PASSED$(NC)"; \
		echo ""; \
		echo "$(BLUE)Generated Bug Test Preview (first 500 chars):$(NC)"; \
		python3 -c "import json; d=json.load(open('$(BUG_RESPONSE_FILE)')); print(d.get('generatedTest', '')[:500])"; \
	else \
		echo "$(RED)API generateBugTest test FAILED$(NC)"; \
		cat $(BUG_RESPONSE_FILE); \
		exit 1; \
	fi

test-api-examples: check-token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Checking Few-Shot Examples Availability$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	echo "$(YELLOW)Checking 'test' command examples...$(NC)"; \
	TEST_COUNT=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/reviewExamples" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"command": "test", "input": "factorial", "language": "python", "limit": 3}' | \
		python3 -c "import sys,json; d=json.load(sys.stdin); print(len(d.get('examples',[])))"); \
	echo "  'test' command: $$TEST_COUNT examples"; \
	echo ""; \
	echo "$(YELLOW)Checking 'fix' command examples...$(NC)"; \
	FIX_COUNT=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/reviewExamples" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"command": "fix", "input": "factorial", "language": "python", "limit": 3}' | \
		python3 -c "import sys,json; d=json.load(sys.stdin); print(len(d.get('examples',[])))"); \
	echo "  'fix' command: $$FIX_COUNT examples"; \
	echo ""; \
	echo "$(YELLOW)Checking 'generate' command examples...$(NC)"; \
	GEN_COUNT=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/reviewExamples" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"command": "generate", "input": "factorial", "language": "python", "limit": 3}' | \
		python3 -c "import sys,json; d=json.load(sys.stdin); print(len(d.get('examples',[])))"); \
	echo "  'generate' command: $$GEN_COUNT examples"; \
	echo ""; \
	if [ "$$FIX_COUNT" -gt 0 ] || [ "$$GEN_COUNT" -gt 0 ]; then \
		echo "$(GREEN)Few-shot examples available for fallback!$(NC)"; \
	else \
		echo "$(YELLOW)Warning: No few-shot examples found. Test will proceed without enhancement.$(NC)"; \
	fi

# ============================================================================
# Example Content Validation Tests
# ============================================================================
test-examples-content: check-token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Validating Example Content Structure$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	echo "$(YELLOW)Fetching examples from reviewExamples endpoint...$(NC)"; \
	curl -s -X POST "$(STAGING_CLOUD_URL)/reviewExamples" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"command": "test", "input": "factorial function implementation", "language": "python", "limit": 5}' \
		-o $(EXAMPLES_RESPONSE_FILE); \
	echo ""; \
	echo "$(YELLOW)Validating example structure and content...$(NC)"; \
	python3 $(PDD_LOCAL_DIR)/scripts/validate_examples.py --mode examples --file $(EXAMPLES_RESPONSE_FILE)

test-examples-by-language: check-token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Validating Examples by Language$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	FAILED=0; \
	for LANG in python typescript; do \
		echo "$(YELLOW)Testing $$LANG examples...$(NC)"; \
		curl -s -X POST "$(STAGING_CLOUD_URL)/reviewExamples" \
			-H "Authorization: Bearer $$TOKEN" \
			-H "Content-Type: application/json" \
			-d "{\"command\": \"test\", \"input\": \"function implementation\", \"language\": \"$$LANG\", \"limit\": 3}" \
			-o /tmp/pdd_lang_test_$$LANG.json; \
		COUNT=$$(python3 -c "import json; d=json.load(open('/tmp/pdd_lang_test_$$LANG.json')); print(len(d.get('examples',[])))"); \
		echo "  $$LANG: $$COUNT examples found"; \
		if [ "$$COUNT" -eq 0 ]; then \
			echo "$(RED)  FAIL: No examples found for $$LANG$(NC)"; \
			FAILED=1; \
		fi; \
	done; \
	echo ""; \
	if [ "$$FAILED" -eq 1 ]; then \
		echo "$(RED)Language validation FAILED$(NC)"; \
		exit 1; \
	else \
		echo "$(GREEN)Language validation PASSED$(NC)"; \
	fi

# ============================================================================
# GCloud Log Verification Tests
# ============================================================================
test-logs: check-token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Querying GCloud Logs for Few-Shot Examples$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@echo "$(YELLOW)Querying generateTest and reviewExamples logs...$(NC)"
	@echo "$(YELLOW)(Using cloud_run_revision resource type for Gen 2 functions)$(NC)"
	@gcloud logging read \
		'textPayload=~"examples" OR textPayload=~"Enhanced prompt" OR textPayload=~"Retrieved example"' \
		--project=$(GCP_PROJECT_ID) \
		--limit=50 \
		--freshness=$(LOG_WINDOW_MINUTES)m \
		--format=json > $(LOG_RESPONSE_FILE) 2>/dev/null || echo "[]" > $(LOG_RESPONSE_FILE)
	@echo ""
	@python3 $(PDD_LOCAL_DIR)/scripts/validate_examples.py --mode logs --file $(LOG_RESPONSE_FILE)

test-examples-e2e: check-token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Running Full Examples E2E Test$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@START_TIME=$$(date -u +"%Y-%m-%dT%H:%M:%SZ"); \
	echo "$(YELLOW)Test start time: $$START_TIME$(NC)"; \
	echo ""; \
	TOKEN=$$(cat $(TOKEN_FILE)); \
	echo "$(YELLOW)Step 1: Calling generateTest API...$(NC)"; \
	curl -s -X POST "$(STAGING_CLOUD_URL)/generateTest" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"promptContent": "Write a function to calculate factorial", "codeContent": "def factorial(n):\n    if n <= 1:\n        return 1\n    return n * factorial(n - 1)", "language": "python", "mode": "generate", "strength": 0.75, "temperature": 0.0, "verbose": true}' \
		-o $(RESPONSE_FILE); \
	echo ""; \
	echo "$(YELLOW)Step 2: Validating generateTest response...$(NC)"; \
	if grep -q "generatedTest" $(RESPONSE_FILE); then \
		echo "$(GREEN)  generateTest returned valid response$(NC)"; \
	else \
		echo "$(RED)FAIL: generateTest did not return valid response$(NC)"; \
		cat $(RESPONSE_FILE); \
		exit 1; \
	fi; \
	echo ""; \
	echo "$(YELLOW)Step 3: Waiting 10s for logs to propagate...$(NC)"; \
	sleep 10; \
	echo ""; \
	echo "$(YELLOW)Step 4: Querying GCloud logs...$(NC)"; \
	gcloud logging read \
		"resource.type=\"cloud_function\" AND (resource.labels.function_name=\"generateTest\" OR resource.labels.function_name=\"reviewExamples\") AND timestamp>=\"$$START_TIME\"" \
		--project=$(GCP_PROJECT_ID) \
		--limit=100 \
		--format=json > $(LOG_RESPONSE_FILE) 2>/dev/null || echo "[]" > $(LOG_RESPONSE_FILE); \
	echo ""; \
	echo "$(YELLOW)Step 5: Validating log entries...$(NC)"; \
	python3 $(PDD_LOCAL_DIR)/scripts/validate_examples.py --mode logs --file $(LOG_RESPONSE_FILE)
	@echo ""
	@echo "$(GREEN)E2E test completed$(NC)"

# ============================================================================
# CLI Tests
# ============================================================================
create-test-files:
	@echo "$(BLUE)Creating test files...$(NC)"
	@mkdir -p $(TEST_PROMPT_DIR)/prompts
	@mkdir -p $(TEST_PROMPT_DIR)/src
	@mkdir -p $(TEST_PROMPT_DIR)/tests
	@echo "Write a function to calculate the factorial of a number" > $(TEST_PROMPT_FILE)
	@echo "def factorial(n):" > $(TEST_CODE_FILE)
	@echo "    \"\"\"Calculate the factorial of n.\"\"\"" >> $(TEST_CODE_FILE)
	@echo "    if n <= 1:" >> $(TEST_CODE_FILE)
	@echo "        return 1" >> $(TEST_CODE_FILE)
	@echo "    return n * factorial(n - 1)" >> $(TEST_CODE_FILE)
	@echo "$(GREEN)Created:$(NC)"
	@echo "  - $(TEST_PROMPT_FILE)"
	@echo "  - $(TEST_CODE_FILE)"

create-generate-files:
	@echo "$(BLUE)Creating generate test files...$(NC)"
	@mkdir -p $(TEST_PROMPT_DIR)/prompts
	@mkdir -p $(TEST_PROMPT_DIR)/src
	@echo "Write a Python function called sum_numbers that takes a list of numbers and returns their sum." > $(GENERATE_PROMPT_FILE)
	@echo "Handle empty lists by returning 0." >> $(GENERATE_PROMPT_FILE)
	@echo "" >> $(GENERATE_PROMPT_FILE)
	@echo '```python' >> $(GENERATE_PROMPT_FILE)
	@echo "def sum_numbers(numbers: list) -> int:" >> $(GENERATE_PROMPT_FILE)
	@echo "    pass  # TODO: implement" >> $(GENERATE_PROMPT_FILE)
	@echo '```' >> $(GENERATE_PROMPT_FILE)
	@echo "# Placeholder for language detection" > $(GENERATE_OUTPUT_FILE)
	@echo "$(GREEN)Created:$(NC)"
	@echo "  - $(GENERATE_PROMPT_FILE)"
	@echo "  - $(GENERATE_OUTPUT_FILE) (placeholder)"

create-example-files:
	@echo "$(BLUE)Creating example test files...$(NC)"
	@mkdir -p $(TEST_PROMPT_DIR)/prompts
	@mkdir -p $(TEST_PROMPT_DIR)/src
	@mkdir -p $(TEST_PROMPT_DIR)/examples
	@echo "Write a function to multiply two numbers" > $(EXAMPLE_PROMPT_FILE)
	@echo "def multiply(a, b):" > $(EXAMPLE_CODE_FILE)
	@echo "    \"\"\"Multiply two numbers together.\"\"\"" >> $(EXAMPLE_CODE_FILE)
	@echo "    return a * b" >> $(EXAMPLE_CODE_FILE)
	@echo "$(GREEN)Created:$(NC)"
	@echo "  - $(EXAMPLE_PROMPT_FILE)"
	@echo "  - $(EXAMPLE_CODE_FILE)"

create-fix-files:
	@echo "$(BLUE)Creating fix test files...$(NC)"
	@mkdir -p $(TEST_PROMPT_DIR)/prompts
	@mkdir -p $(TEST_PROMPT_DIR)/src
	@mkdir -p $(TEST_PROMPT_DIR)/tests
	@mkdir -p $(TEST_PROMPT_DIR)/errors
	@mkdir -p $(TEST_PROMPT_DIR)/scripts
	@echo "Write a function to safely divide two numbers. Return 0 if dividing by zero." > $(FIX_PROMPT_FILE)
	@echo "def divide(a, b):" > $(FIX_CODE_FILE)
	@echo "    \"\"\"Divide a by b.\"\"\"" >> $(FIX_CODE_FILE)
	@echo "    return a / b" >> $(FIX_CODE_FILE)
	@echo "import pytest" > $(FIX_TEST_FILE)
	@echo "from divide import divide" >> $(FIX_TEST_FILE)
	@echo "" >> $(FIX_TEST_FILE)
	@echo "def test_divide_normal():" >> $(FIX_TEST_FILE)
	@echo "    assert divide(10, 2) == 5" >> $(FIX_TEST_FILE)
	@echo "" >> $(FIX_TEST_FILE)
	@echo "def test_divide_by_zero():" >> $(FIX_TEST_FILE)
	@echo "    assert divide(10, 0) == 0  # Should handle division by zero" >> $(FIX_TEST_FILE)
	@echo "FAILED tests/test_divide.py::test_divide_by_zero - ZeroDivisionError: division by zero" > $(FIX_ERROR_FILE)
	@echo "#!/usr/bin/env python3" > $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "\"\"\"Verification script for divide function.\"\"\"" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "import sys" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "import os" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "from divide import divide" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "def main():" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "    # Test normal division" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "    assert divide(10, 2) == 5, 'Normal division failed'" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "    # Test division by zero" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "    assert divide(10, 0) == 0, 'Division by zero should return 0'" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "    print('All tests passed!')" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "    return 0" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "if __name__ == '__main__':" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "    sys.exit(main())" >> $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@chmod +x $(TEST_PROMPT_DIR)/scripts/verify_divide.py
	@echo "$(GREEN)Created:$(NC)"
	@echo "  - $(FIX_PROMPT_FILE)"
	@echo "  - $(FIX_CODE_FILE)"
	@echo "  - $(FIX_TEST_FILE)"
	@echo "  - $(FIX_ERROR_FILE)"
	@echo "  - $(TEST_PROMPT_DIR)/scripts/verify_divide.py"

create-crash-files:
	@echo "$(BLUE)Creating crash test files...$(NC)"
	@mkdir -p $(TEST_PROMPT_DIR)/prompts
	@mkdir -p $(TEST_PROMPT_DIR)/src
	@mkdir -p $(TEST_PROMPT_DIR)/scripts
	@mkdir -p $(TEST_PROMPT_DIR)/errors
	@echo "Write a function to multiply a number by two" > $(CRASH_PROMPT_FILE)
	@echo "def multiply_by_two(x):" > $(CRASH_CODE_FILE)
	@echo "    \"\"\"Multiply x by two.\"\"\"" >> $(CRASH_CODE_FILE)
	@echo "    return x * 2" >> $(CRASH_CODE_FILE)
	@echo "#!/usr/bin/env python3" > $(CRASH_PROGRAM_FILE)
	@echo "from crash_multiply import multiply_by_two" >> $(CRASH_PROGRAM_FILE)
	@echo "" >> $(CRASH_PROGRAM_FILE)
	@echo "# This will crash with a string input" >> $(CRASH_PROGRAM_FILE)
	@echo "result = multiply_by_two(\"5\")" >> $(CRASH_PROGRAM_FILE)
	@echo "print(f\"Result: {result}\")" >> $(CRASH_PROGRAM_FILE)
	@chmod +x $(CRASH_PROGRAM_FILE)
	@echo "Traceback (most recent call last):" > $(CRASH_ERROR_FILE)
	@echo "  File \"run_multiply.py\", line 5, in <module>" >> $(CRASH_ERROR_FILE)
	@echo "    result = multiply_by_two(\"5\")" >> $(CRASH_ERROR_FILE)
	@echo "TypeError: can't multiply sequence by non-int of type 'int'" >> $(CRASH_ERROR_FILE)
	@echo "$(GREEN)Created:$(NC)"
	@echo "  - $(CRASH_PROMPT_FILE)"
	@echo "  - $(CRASH_CODE_FILE)"
	@echo "  - $(CRASH_PROGRAM_FILE)"
	@echo "  - $(CRASH_ERROR_FILE)"

create-verify-files:
	@echo "$(BLUE)Creating verify test files...$(NC)"
	@mkdir -p $(TEST_PROMPT_DIR)/prompts
	@mkdir -p $(TEST_PROMPT_DIR)/src
	@mkdir -p $(TEST_PROMPT_DIR)/scripts
	@echo "Write a function to add two numbers" > $(VERIFY_PROMPT_FILE)
	@echo "def add(a, b):" > $(VERIFY_CODE_FILE)
	@echo "    \"\"\"Add two numbers together.\"\"\"" >> $(VERIFY_CODE_FILE)
	@echo "    return a + b" >> $(VERIFY_CODE_FILE)
	@echo "#!/usr/bin/env python3" > $(VERIFY_PROGRAM_FILE)
	@echo "from verify_add import add" >> $(VERIFY_PROGRAM_FILE)
	@echo "" >> $(VERIFY_PROGRAM_FILE)
	@echo "result = add(2, 3)" >> $(VERIFY_PROGRAM_FILE)
	@echo "print(f\"Result: {result}\")" >> $(VERIFY_PROGRAM_FILE)
	@chmod +x $(VERIFY_PROGRAM_FILE)
	@echo "$(GREEN)Created:$(NC)"
	@echo "  - $(VERIFY_PROMPT_FILE)"
	@echo "  - $(VERIFY_CODE_FILE)"
	@echo "  - $(VERIFY_PROGRAM_FILE)"

create-bug-files:
	@echo "$(BLUE)Creating bug test files...$(NC)"
	@mkdir -p $(TEST_PROMPT_DIR)/prompts
	@mkdir -p $(TEST_PROMPT_DIR)/src
	@mkdir -p $(TEST_PROMPT_DIR)/scripts
	@mkdir -p $(TEST_PROMPT_DIR)/outputs
	@mkdir -p $(TEST_PROMPT_DIR)/tests
	@echo "Write a function to add two numbers" > $(BUG_PROMPT_FILE)
	@echo "def add(a, b):" > $(BUG_CODE_FILE)
	@echo "    \"\"\"Add two numbers together.\"\"\"" >> $(BUG_CODE_FILE)
	@echo "    return a - b  # Bug: should be +" >> $(BUG_CODE_FILE)
	@echo "#!/usr/bin/env python3" > $(BUG_PROGRAM_FILE)
	@echo "from bug_add import add" >> $(BUG_PROGRAM_FILE)
	@echo "" >> $(BUG_PROGRAM_FILE)
	@echo "result = add(2, 3)" >> $(BUG_PROGRAM_FILE)
	@echo "print(f\"Result: {result}\")" >> $(BUG_PROGRAM_FILE)
	@chmod +x $(BUG_PROGRAM_FILE)
	@echo "-1" > $(BUG_CURRENT_OUTPUT_FILE)
	@echo "5" > $(BUG_DESIRED_OUTPUT_FILE)
	@echo "$(GREEN)Created:$(NC)"
	@echo "  - $(BUG_PROMPT_FILE)"
	@echo "  - $(BUG_CODE_FILE)"
	@echo "  - $(BUG_PROGRAM_FILE)"
	@echo "  - $(BUG_CURRENT_OUTPUT_FILE)"
	@echo "  - $(BUG_DESIRED_OUTPUT_FILE)"

test-cli: check-token create-test-files
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing 'pdd test' CLI command with cloud$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Running: pdd --verbose test$(NC)"; \
	echo "$(YELLOW)Using local pdd via PYTHONPATH: $(PDD_LOCAL_DIR)$(NC)"; \
	echo ""; \
	export PDD_JWT_TOKEN=$$TOKEN; \
	export PDD_CLOUD_URL=$(STAGING_CLOUD_URL); \
	export PDD_AUTO_UPDATE=false; \
	cd $(TEST_PROMPT_DIR) && $(PYTHONPATH_LOCAL) python -m pdd.cli --force --verbose test \
		prompts/test_factorial.prompt \
		src/factorial.py \
		--output tests/test_factorial_generated.py 2>&1 | \
		grep -E "(Cloud|cloud|Success|success|Model|Cost|Attempting|Falling|staging|credits|Generated|Error|error)" | head -30; \
	echo ""; \
	AFTER=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	DIFF=$$((BEFORE - AFTER)); \
	echo "$(YELLOW)Balance after: $$AFTER PDDC$(NC)"; \
	echo "$(GREEN)CLI test completed$(NC) - Credits used: $$DIFF"; \
	echo ""; \
	if [ -f $(TEST_OUTPUT_FILE) ]; then \
		echo "$(GREEN)Output file created: $(TEST_OUTPUT_FILE)$(NC)"; \
		echo ""; \
		echo "$(BLUE)Generated Test Preview (first 500 chars):$(NC)"; \
		head -c 500 $(TEST_OUTPUT_FILE); \
		echo ""; \
	else \
		echo "$(RED)Warning: Output file not created$(NC)"; \
	fi

test-cli-generate: check-token create-generate-files
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing 'pdd generate' CLI command with cloud$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Running: pdd --verbose generate$(NC)"; \
	echo "$(YELLOW)Using local pdd via PYTHONPATH: $(PDD_LOCAL_DIR)$(NC)"; \
	echo ""; \
	export PDD_JWT_TOKEN=$$TOKEN; \
	export PDD_CLOUD_URL=$(STAGING_CLOUD_URL); \
	export PDD_AUTO_UPDATE=false; \
	cd $(TEST_PROMPT_DIR) && $(PYTHONPATH_LOCAL) python -m pdd.cli --force --verbose generate \
		prompts/sum_python.prompt \
		--output src/sum_generated.py 2>&1 | \
		grep -E "(Cloud|cloud|Success|success|Model|Cost|Attempting|Falling|staging|credits|Generated|Error|error)" | head -30; \
	echo ""; \
	AFTER=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	DIFF=$$((BEFORE - AFTER)); \
	echo "$(YELLOW)Balance after: $$AFTER PDDC$(NC)"; \
	echo "$(GREEN)CLI generate test completed$(NC) - Credits used: $$DIFF"; \
	echo ""; \
	if [ -f $(GENERATE_OUTPUT_FILE) ]; then \
		echo "$(GREEN)Output file created: $(GENERATE_OUTPUT_FILE)$(NC)"; \
		echo ""; \
		echo "$(BLUE)Generated Code Preview (first 500 chars):$(NC)"; \
		head -c 500 $(GENERATE_OUTPUT_FILE); \
		echo ""; \
	else \
		echo "$(RED)Warning: Output file not created$(NC)"; \
	fi

test-cli-example: check-token create-example-files
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing 'pdd example' CLI command with cloud$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Running: pdd --verbose example$(NC)"; \
	echo "$(YELLOW)Using local pdd via PYTHONPATH: $(PDD_LOCAL_DIR)$(NC)"; \
	echo ""; \
	export PDD_JWT_TOKEN=$$TOKEN; \
	export PDD_CLOUD_URL=$(STAGING_CLOUD_URL); \
	export PDD_AUTO_UPDATE=false; \
	cd $(TEST_PROMPT_DIR) && $(PYTHONPATH_LOCAL) python -m pdd.cli --force --verbose example \
		prompts/example_multiply.prompt \
		src/multiply.py \
		--output examples/multiply_example.py 2>&1 | \
		grep -E "(Cloud|cloud|Success|success|Model|Cost|Attempting|Falling|staging|credits|Generated|Error|error)" | head -30; \
	echo ""; \
	AFTER=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	DIFF=$$((BEFORE - AFTER)); \
	echo "$(YELLOW)Balance after: $$AFTER PDDC$(NC)"; \
	echo "$(GREEN)CLI example test completed$(NC) - Credits used: $$DIFF"; \
	echo ""; \
	if [ -f $(EXAMPLE_OUTPUT_FILE) ]; then \
		echo "$(GREEN)Output file created: $(EXAMPLE_OUTPUT_FILE)$(NC)"; \
		echo ""; \
		echo "$(BLUE)Generated Example Preview (first 500 chars):$(NC)"; \
		head -c 500 $(EXAMPLE_OUTPUT_FILE); \
		echo ""; \
	else \
		echo "$(RED)Warning: Output file not created$(NC)"; \
	fi

test-cli-fix: check-token create-fix-files
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing 'pdd fix' CLI command with cloud$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Running: pdd --verbose fix$(NC)"; \
	echo "$(YELLOW)Using local pdd via PYTHONPATH: $(PDD_LOCAL_DIR)$(NC)"; \
	echo ""; \
	export PDD_JWT_TOKEN=$$TOKEN; \
	export PDD_CLOUD_URL=$(STAGING_CLOUD_URL); \
	export PDD_AUTO_UPDATE=false; \
	cd $(TEST_PROMPT_DIR) && $(PYTHONPATH_LOCAL) python -m pdd.cli --force --verbose fix \
		prompts/fix_divide.prompt \
		src/divide.py \
		tests/test_divide.py \
		errors/divide_errors.txt \
		--output-code src/divide_fixed.py \
		--output-test tests/test_divide_fixed.py 2>&1 | \
		grep -E "(Cloud|cloud|Success|success|Model|Cost|Attempting|Falling|staging|credits|Fixed|Error|error)" | head -30; \
	echo ""; \
	AFTER=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	DIFF=$$((BEFORE - AFTER)); \
	echo "$(YELLOW)Balance after: $$AFTER PDDC$(NC)"; \
	echo "$(GREEN)CLI fix test completed$(NC) - Credits used: $$DIFF"; \
	echo ""; \
	if [ -f $(FIX_OUTPUT_CODE) ] || [ -f $(FIX_OUTPUT_TEST) ]; then \
		echo "$(GREEN)Output files created$(NC)"; \
		if [ -f $(FIX_OUTPUT_CODE) ]; then \
			echo ""; \
			echo "$(BLUE)Fixed Code Preview (first 500 chars):$(NC)"; \
			head -c 500 $(FIX_OUTPUT_CODE); \
			echo ""; \
		fi; \
	else \
		echo "$(RED)Warning: Output files not created$(NC)"; \
	fi

test-cli-fix-loop: check-token create-fix-files
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing 'pdd fix --loop' CLI command with cloud$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Running: pdd --verbose fix --loop$(NC)"; \
	echo "$(YELLOW)Using local pdd via PYTHONPATH: $(PDD_LOCAL_DIR)$(NC)"; \
	echo ""; \
	export PDD_JWT_TOKEN=$$TOKEN; \
	export PDD_CLOUD_URL=$(STAGING_CLOUD_URL); \
	export PDD_AUTO_UPDATE=false; \
	cd $(TEST_PROMPT_DIR) && $(PYTHONPATH_LOCAL) python -m pdd.cli --force --verbose fix \
		prompts/fix_divide.prompt \
		src/divide.py \
		tests/test_divide.py \
		errors/divide_errors.txt \
		--loop \
		--max-attempts 3 \
		--budget 2.0 \
		--verification-program scripts/verify_divide.py \
		--output-code src/divide_fixed_loop.py \
		--output-test tests/test_divide_fixed_loop.py 2>&1 | \
		grep -E "(Cloud|cloud|Success|success|Model|Cost|Attempting|Falling|staging|credits|Fixed|Error|error|Loop|loop|Attempt|attempt|iteration|Verification|verification)" | head -50; \
	echo ""; \
	AFTER=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	DIFF=$$((BEFORE - AFTER)); \
	echo "$(YELLOW)Balance after: $$AFTER PDDC$(NC)"; \
	echo "$(GREEN)CLI fix --loop test completed$(NC) - Credits used: $$DIFF"; \
	echo ""; \
	if [ -f $(TEST_PROMPT_DIR)/src/divide_fixed_loop.py ] || [ -f $(TEST_PROMPT_DIR)/tests/test_divide_fixed_loop.py ]; then \
		echo "$(GREEN)Output files created$(NC)"; \
		if [ -f $(TEST_PROMPT_DIR)/src/divide_fixed_loop.py ]; then \
			echo ""; \
			echo "$(BLUE)Fixed Code Preview (first 500 chars):$(NC)"; \
			head -c 500 $(TEST_PROMPT_DIR)/src/divide_fixed_loop.py; \
			echo ""; \
		fi; \
	else \
		echo "$(RED)Warning: Output files not created$(NC)"; \
	fi

test-cli-bug: check-token create-bug-files
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing 'pdd bug' CLI command with cloud$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Running: pdd --verbose bug$(NC)"; \
	echo "$(YELLOW)Using local pdd via PYTHONPATH: $(PDD_LOCAL_DIR)$(NC)"; \
	echo ""; \
	export PDD_JWT_TOKEN=$$TOKEN; \
	export PDD_CLOUD_URL=$(STAGING_CLOUD_URL); \
	export PDD_AUTO_UPDATE=false; \
	cd $(TEST_PROMPT_DIR) && $(PYTHONPATH_LOCAL) python -m pdd.cli --force --verbose bug \
		prompts/bug_add.prompt \
		src/bug_add.py \
		scripts/run_bug_add.py \
		outputs/bug_current_output.txt \
		outputs/bug_desired_output.txt \
		--output tests/test_bug_add_generated.py 2>&1 | \
		grep -E "(Cloud|cloud|Success|success|Model|Cost|Attempting|Falling|staging|credits|Generated|Bug|bug|Test|Error|error)" | head -30; \
	echo ""; \
	AFTER=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	DIFF=$$((BEFORE - AFTER)); \
	echo "$(YELLOW)Balance after: $$AFTER PDDC$(NC)"; \
	echo "$(GREEN)CLI bug test completed$(NC) - Credits used: $$DIFF"; \
	echo ""; \
	if [ -f $(TEST_PROMPT_DIR)/tests/test_bug_add_generated.py ]; then \
		echo "$(GREEN)Output file created: $(TEST_PROMPT_DIR)/tests/test_bug_add_generated.py$(NC)"; \
		echo ""; \
		echo "$(BLUE)Generated Bug Test Preview (first 500 chars):$(NC)"; \
		head -c 500 $(TEST_PROMPT_DIR)/tests/test_bug_add_generated.py; \
		echo ""; \
	else \
		echo "$(RED)Warning: Output file not created$(NC)"; \
	fi

test-cli-crash: check-token create-crash-files
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing 'pdd crash' CLI command with cloud$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Running: pdd --verbose crash$(NC)"; \
	echo "$(YELLOW)Using local pdd via PYTHONPATH: $(PDD_LOCAL_DIR)$(NC)"; \
	echo ""; \
	export PDD_JWT_TOKEN=$$TOKEN; \
	export PDD_CLOUD_URL=$(STAGING_CLOUD_URL); \
	export PDD_AUTO_UPDATE=false; \
	cd $(TEST_PROMPT_DIR) && $(PYTHONPATH_LOCAL) python -m pdd.cli --force --verbose crash \
		prompts/crash_multiply.prompt \
		src/crash_multiply.py \
		scripts/run_multiply.py \
		errors/multiply_crash.txt \
		--output src/crash_multiply_fixed.py \
		--output-program scripts/run_multiply_fixed.py 2>&1 | \
		grep -E "(Cloud|cloud|Success|success|Model|Cost|Attempting|Falling|staging|credits|Fixed|Error|error|crash|Crash)" | head -30; \
	echo ""; \
	AFTER=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	DIFF=$$((BEFORE - AFTER)); \
	echo "$(YELLOW)Balance after: $$AFTER PDDC$(NC)"; \
	echo "$(GREEN)CLI crash test completed$(NC) - Credits used: $$DIFF"; \
	echo ""; \
	if [ -f $(CRASH_OUTPUT_CODE) ] || [ -f $(CRASH_OUTPUT_PROGRAM) ]; then \
		echo "$(GREEN)Output files created$(NC)"; \
		if [ -f $(CRASH_OUTPUT_CODE) ]; then \
			echo ""; \
			echo "$(BLUE)Fixed Code Preview (first 500 chars):$(NC)"; \
			head -c 500 $(CRASH_OUTPUT_CODE); \
			echo ""; \
		fi; \
	else \
		echo "$(RED)Warning: Output files not created$(NC)"; \
	fi

test-cli-crash-loop: check-token create-crash-files
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing 'pdd crash --loop' CLI command with cloud$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Running: pdd --verbose crash --loop --max-attempts 3 --budget 2.0$(NC)"; \
	echo "$(YELLOW)Using local pdd via PYTHONPATH: $(PDD_LOCAL_DIR)$(NC)"; \
	echo ""; \
	export PDD_JWT_TOKEN=$$TOKEN; \
	export PDD_CLOUD_URL=$(STAGING_CLOUD_URL); \
	export PDD_AUTO_UPDATE=false; \
	cd $(TEST_PROMPT_DIR) && $(PYTHONPATH_LOCAL) python -m pdd.cli --force --verbose crash \
		prompts/crash_multiply.prompt \
		src/crash_multiply.py \
		scripts/run_multiply.py \
		errors/multiply_crash.txt \
		--loop \
		--max-attempts 3 \
		--budget 2.0 \
		--output src/crash_multiply_fixed_loop.py \
		--output-program scripts/run_multiply_fixed_loop.py 2>&1 | \
		grep -E "(Cloud|cloud|Success|success|Model|Cost|Attempting|Falling|staging|credits|Fixed|Error|error|crash|Crash|Loop|loop|Attempt|attempt|iteration)" | head -50; \
	echo ""; \
	AFTER=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	DIFF=$$((BEFORE - AFTER)); \
	echo "$(YELLOW)Balance after: $$AFTER PDDC$(NC)"; \
	echo "$(GREEN)CLI crash --loop test completed$(NC) - Credits used: $$DIFF"; \
	echo ""; \
	if [ -f $(TEST_PROMPT_DIR)/src/crash_multiply_fixed_loop.py ] || [ -f $(TEST_PROMPT_DIR)/scripts/run_multiply_fixed_loop.py ]; then \
		echo "$(GREEN)Output files created$(NC)"; \
		if [ -f $(TEST_PROMPT_DIR)/src/crash_multiply_fixed_loop.py ]; then \
			echo ""; \
			echo "$(BLUE)Fixed Code Preview (first 500 chars):$(NC)"; \
			head -c 500 $(TEST_PROMPT_DIR)/src/crash_multiply_fixed_loop.py; \
			echo ""; \
		fi; \
	else \
		echo "$(RED)Warning: Output files not created$(NC)"; \
	fi

test-cli-verify: check-token create-verify-files
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing 'pdd verify' CLI command with cloud$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Running: pdd --verbose verify$(NC)"; \
	echo "$(YELLOW)Using local pdd via PYTHONPATH: $(PDD_LOCAL_DIR)$(NC)"; \
	echo ""; \
	export PDD_JWT_TOKEN=$$TOKEN; \
	export PDD_CLOUD_URL=$(STAGING_CLOUD_URL); \
	export PDD_AUTO_UPDATE=false; \
	cd $(TEST_PROMPT_DIR) && $(PYTHONPATH_LOCAL) python -m pdd.cli --force --verbose verify \
		prompts/verify_add.prompt \
		src/verify_add.py \
		scripts/run_add.py \
		--output-code src/verify_add_verified.py \
		--output-program scripts/run_add_verified.py 2>&1 | \
		grep -E "(Cloud|cloud|Success|success|Model|Cost|Attempting|Falling|staging|credits|Verified|verify|Verify|Error|error)" | head -30; \
	echo ""; \
	AFTER=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	DIFF=$$((BEFORE - AFTER)); \
	echo "$(YELLOW)Balance after: $$AFTER PDDC$(NC)"; \
	echo "$(GREEN)CLI verify test completed$(NC) - Credits used: $$DIFF"; \
	echo ""; \
	if [ -f $(VERIFY_OUTPUT_CODE) ] || [ -f $(VERIFY_OUTPUT_PROGRAM) ]; then \
		echo "$(GREEN)Output files created$(NC)"; \
		if [ -f $(VERIFY_OUTPUT_CODE) ]; then \
			echo ""; \
			echo "$(BLUE)Verified Code Preview (first 500 chars):$(NC)"; \
			head -c 500 $(VERIFY_OUTPUT_CODE); \
			echo ""; \
		fi; \
	else \
		echo "$(RED)Warning: Output files not created$(NC)"; \
	fi

# ============================================================================
# Full Test Suite
# ============================================================================
full-test: token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Running Full PDD Cloud E2E Test Suite$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@echo "$(YELLOW)Step 1/22: User Info$(NC)"
	@$(MAKE) -f Makefile.test-staging show-user --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 2/22: Starting Balance$(NC)"
	@$(MAKE) -f Makefile.test-staging balance --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 3/22: Few-Shot Examples Check$(NC)"
	@$(MAKE) -f Makefile.test-staging test-api-examples --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 4/22: Example Content Validation$(NC)"
	@$(MAKE) -f Makefile.test-staging test-examples-content --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 5/22: Language-Specific Validation$(NC)"
	@$(MAKE) -f Makefile.test-staging test-examples-by-language --no-print-directory
	@echo ""
	@echo "$(BLUE)--- API Endpoint Tests ---$(NC)"
	@echo ""
	@echo "$(YELLOW)Step 6/22: API generateTest Endpoint$(NC)"
	@$(MAKE) -f Makefile.test-staging test-api --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 7/22: API generateCode Endpoint$(NC)"
	@$(MAKE) -f Makefile.test-staging test-api-generate --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 8/22: API generateExample Endpoint$(NC)"
	@$(MAKE) -f Makefile.test-staging test-api-example --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 9/22: API fixCode Endpoint$(NC)"
	@$(MAKE) -f Makefile.test-staging test-api-fix --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 10/22: API crashCode Endpoint$(NC)"
	@$(MAKE) -f Makefile.test-staging test-api-crash --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 11/22: API generateBugTest Endpoint$(NC)"
	@$(MAKE) -f Makefile.test-staging test-api-bug --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 12/22: API verifyCode Endpoint$(NC)"
	@$(MAKE) -f Makefile.test-staging test-api-verify --no-print-directory
	@echo ""
	@echo "$(BLUE)--- CLI Command Tests ---$(NC)"
	@echo ""
	@echo "$(YELLOW)Step 13/22: CLI 'pdd test' Command$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 14/22: CLI 'pdd generate' Command$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-generate --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 15/22: CLI 'pdd example' Command$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-example --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 16/22: CLI 'pdd fix' Command$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-fix --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 17/22: CLI 'pdd fix --loop' Command$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-fix-loop --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 18/22: CLI 'pdd bug' Command$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-bug --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 19/22: CLI 'pdd crash' Command$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-crash --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 20/22: CLI 'pdd crash --loop' Command$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-crash-loop --no-print-directory
	@echo ""
	@echo "$(BLUE)--- Verification ---$(NC)"
	@echo ""
	@echo "$(YELLOW)Step 21/22: GCloud Log Verification$(NC)"
	@$(MAKE) -f Makefile.test-staging test-logs --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 22/22: Final Balance$(NC)"
	@$(MAKE) -f Makefile.test-staging balance --no-print-directory
	@echo ""
	@echo "$(GREEN)=================================================$(NC)"
	@echo "$(GREEN)  All PDD Cloud E2E tests completed!$(NC)"
	@echo "$(GREEN)=================================================$(NC)"
	@echo ""
	@echo "View credits at: https://prompt-driven-development-stg.web.app/admin"

# Quick test suite (API only - no CLI)
quick-test: token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Running Quick API Test Suite$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@$(MAKE) -f Makefile.test-staging show-user --no-print-directory
	@$(MAKE) -f Makefile.test-staging balance --no-print-directory
	@$(MAKE) -f Makefile.test-staging test-api --no-print-directory
	@$(MAKE) -f Makefile.test-staging test-api-generate --no-print-directory
	@$(MAKE) -f Makefile.test-staging test-api-example --no-print-directory
	@$(MAKE) -f Makefile.test-staging test-api-fix --no-print-directory
	@$(MAKE) -f Makefile.test-staging test-api-crash --no-print-directory
	@$(MAKE) -f Makefile.test-staging test-api-bug --no-print-directory
	@$(MAKE) -f Makefile.test-staging test-api-verify --no-print-directory
	@$(MAKE) -f Makefile.test-staging balance --no-print-directory
	@echo ""
	@echo "$(GREEN)Quick API tests completed!$(NC)"

# Comprehensive CLI test suite (all CLI commands with all variants)
test-cli-comprehensive: token
	@echo ""
	@echo "$(BLUE)========================================================$(NC)"
	@echo "$(BLUE)  Running Comprehensive CLI E2E Test Suite$(NC)"
	@echo "$(BLUE)  Testing: fix, fix --loop, bug, crash, crash --loop, verify$(NC)"
	@echo "$(BLUE)========================================================$(NC)"
	@echo ""
	@$(MAKE) -f Makefile.test-staging show-user --no-print-directory
	@START_BALANCE=$$(cat $(TOKEN_FILE) | xargs -I {} curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer {}" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(BLUE)Starting Balance: $$START_BALANCE PDDC$(NC)"; \
	echo ""
	@echo ""
	@echo "$(BLUE)--- Test 1/9: pdd test (generate unit tests) ---$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli --no-print-directory
	@echo ""
	@echo "$(BLUE)--- Test 2/9: pdd generate (generate code) ---$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-generate --no-print-directory
	@echo ""
	@echo "$(BLUE)--- Test 3/9: pdd example (generate usage example) ---$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-example --no-print-directory
	@echo ""
	@echo "$(BLUE)--- Test 4/9: pdd fix (single-shot fix) ---$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-fix --no-print-directory
	@echo ""
	@echo "$(BLUE)--- Test 5/9: pdd fix --loop (iterative fix) ---$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-fix-loop --no-print-directory
	@echo ""
	@echo "$(BLUE)--- Test 6/9: pdd bug (generate bug test) ---$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-bug --no-print-directory
	@echo ""
	@echo "$(BLUE)--- Test 7/9: pdd crash (single-shot crash fix) ---$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-crash --no-print-directory
	@echo ""
	@echo "$(BLUE)--- Test 8/9: pdd crash --loop (iterative crash fix) ---$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-crash-loop --no-print-directory
	@echo ""
	@echo "$(BLUE)--- Test 9/9: pdd verify (verification loop) ---$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli-verify --no-print-directory
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	END_BALANCE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(BLUE)Final Balance: $$END_BALANCE PDDC$(NC)"
	@echo ""
	@echo "$(GREEN)========================================================$(NC)"
	@echo "$(GREEN)  Comprehensive CLI E2E Test Suite Complete!$(NC)"
	@echo "$(GREEN)========================================================$(NC)"

# Comprehensive CLI test with GCloud log verification
test-cli-with-logs: token
	@echo ""
	@echo "$(BLUE)=========================================================$(NC)"
	@echo "$(BLUE)  Running CLI Tests with GCloud Log Verification$(NC)"
	@echo "$(BLUE)=========================================================$(NC)"
	@echo ""
	@START_TIME=$$(date -u +"%Y-%m-%dT%H:%M:%SZ"); \
	echo "$(YELLOW)Test start time: $$START_TIME$(NC)"; \
	echo ""; \
	echo "$(BLUE)Step 1: Running comprehensive CLI tests...$(NC)"; \
	$(MAKE) -f Makefile.test-staging test-cli-comprehensive --no-print-directory; \
	echo ""; \
	echo "$(BLUE)Step 2: Waiting 15s for logs to propagate...$(NC)"; \
	sleep 15; \
	echo ""; \
	echo "$(BLUE)Step 3: Querying GCloud logs for example retrieval...$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Checking for 'crashCode' function logs...$(NC)"; \
	CRASH_LOGS=$$(gcloud logging read \
		"resource.type=\"cloud_run_revision\" AND textPayload=~\"crash\" AND timestamp>=\"$$START_TIME\"" \
		--project=$(GCP_PROJECT_ID) \
		--limit=20 \
		--format="value(textPayload)" 2>/dev/null | head -10); \
	if [ -n "$$CRASH_LOGS" ]; then \
		echo "$(GREEN)  Found crashCode logs:$(NC)"; \
		echo "$$CRASH_LOGS" | head -5; \
	else \
		echo "$(YELLOW)  No crashCode logs found in the time window$(NC)"; \
	fi; \
	echo ""; \
	echo "$(YELLOW)Checking for 'verifyCode' function logs...$(NC)"; \
	VERIFY_LOGS=$$(gcloud logging read \
		"resource.type=\"cloud_run_revision\" AND textPayload=~\"verify\" AND timestamp>=\"$$START_TIME\"" \
		--project=$(GCP_PROJECT_ID) \
		--limit=20 \
		--format="value(textPayload)" 2>/dev/null | head -10); \
	if [ -n "$$VERIFY_LOGS" ]; then \
		echo "$(GREEN)  Found verifyCode logs:$(NC)"; \
		echo "$$VERIFY_LOGS" | head -5; \
	else \
		echo "$(YELLOW)  No verifyCode logs found in the time window$(NC)"; \
	fi; \
	echo ""; \
	echo "$(YELLOW)Checking for few-shot example retrieval logs...$(NC)"; \
	EXAMPLE_LOGS=$$(gcloud logging read \
		"textPayload=~\"example\" OR textPayload=~\"Retrieved\" OR textPayload=~\"Enhanced prompt\" AND timestamp>=\"$$START_TIME\"" \
		--project=$(GCP_PROJECT_ID) \
		--limit=50 \
		--format="value(textPayload)" 2>/dev/null | grep -iE "(example|retrieved|enhanced)" | head -10); \
	if [ -n "$$EXAMPLE_LOGS" ]; then \
		echo "$(GREEN)  Found example retrieval logs:$(NC)"; \
		echo "$$EXAMPLE_LOGS"; \
	else \
		echo "$(YELLOW)  No example retrieval logs found$(NC)"; \
	fi; \
	echo ""; \
	echo "$(BLUE)Step 4: Summary of cloud function invocations...$(NC)"; \
	echo ""; \
	for FUNC in generateTest generateCode generateExample fixCode crashCode verifyCode; do \
		COUNT=$$(gcloud logging read \
			"resource.labels.service_name=~\"$$FUNC\" AND timestamp>=\"$$START_TIME\"" \
			--project=$(GCP_PROJECT_ID) \
			--limit=100 \
			--format="value(textPayload)" 2>/dev/null | wc -l | tr -d ' '); \
		echo "  $$FUNC: $$COUNT log entries"; \
	done; \
	echo ""
	@echo ""
	@echo "$(GREEN)=========================================================$(NC)"
	@echo "$(GREEN)  CLI Tests with Log Verification Complete!$(NC)"
	@echo "$(GREEN)=========================================================$(NC)"

# ============================================================================
# Utilities
# ============================================================================
clean:
	@echo "$(BLUE)Cleaning up test files...$(NC)"
	@rm -rf $(TEST_PROMPT_DIR)
	@rm -f $(TOKEN_FILE)
	@rm -f $(RESPONSE_FILE)
	@rm -f $(GENERATE_RESPONSE_FILE)
	@rm -f $(EXAMPLE_RESPONSE_FILE)
	@rm -f $(FIX_RESPONSE_FILE)
	@rm -f /tmp/pdd_check_response.json
	@rm -f /tmp/pdd_balance_response.json
	@rm -f /tmp/pdd_lang_test_*.json
	@echo "$(GREEN)Cleanup complete$(NC)"

show-env:
	@echo ""
	@echo "$(BLUE)Staging Environment Variables:$(NC)"
	@echo ""
	@if [ -f $(TOKEN_FILE) ]; then \
		echo "export PDD_JWT_TOKEN=\$$(cat $(TOKEN_FILE))"; \
	else \
		echo "# Token not found - run 'make -f Makefile.test-staging token' first"; \
	fi
	@echo "export PDD_CLOUD_URL=$(STAGING_CLOUD_URL)"
	@echo "export PYTHONPATH=$(PDD_LOCAL_DIR):\$$PYTHONPATH"
	@echo ""
	@echo "$(YELLOW)Copy and paste the above to set up your shell.$(NC)"

# ============================================================================
# Quick Commands (shortcuts)
# ============================================================================
t: token
u: show-user
b: balance
a: test-api
ag: test-api-generate
ae: test-api-example
af: test-api-fix
ac: test-api-crash
av: test-api-verify
ab: test-api-bug
e: test-api-examples
c: test-cli
cg: test-cli-generate
ce: test-cli-example
cf: test-cli-fix
cfl: test-cli-fix-loop
ccr: test-cli-crash
ccrl: test-cli-crash-loop
cv: test-cli-verify
cb: test-cli-bug
cc: test-cli-comprehensive
cwl: test-cli-with-logs
f: full-test
q: quick-test
ec: test-examples-content
el: test-examples-by-language
l: test-logs
ee: test-examples-e2e
