# Makefile.test-staging - Staging E2E Testing for PDD Test Command (generateTest)
#
# Usage:
#   make -f Makefile.test-staging help          # Show all targets
#   make -f Makefile.test-staging token         # Get fresh JWT token
#   make -f Makefile.test-staging test-api      # Test generateTest API endpoint
#   make -f Makefile.test-staging test-cli      # Test pdd test CLI command
#   make -f Makefile.test-staging full-test     # Run all tests
#
# Prerequisites:
#   - Python 3 with urllib available
#   - Local pdd codebase (uses PYTHONPATH to avoid global install)

.PHONY: help token check-token show-user balance test-api test-api-examples test-cli full-test clean create-test-files

# ============================================================================
# Configuration
# ============================================================================
STAGING_API_KEY := AIzaSyC7rX6OLGVDlzkU8q7nK_i14ggOqjNz2N4
STAGING_EMAIL := staging-cli-test@pdd-staging.com
STAGING_PASSWORD := StagingCLI_Test_2024!
STAGING_CLOUD_URL := https://us-central1-prompt-driven-development-stg.cloudfunctions.net
TOKEN_FILE := /tmp/pdd_staging_token.txt
RESPONSE_FILE := /tmp/pdd_test_response.json

# Local PDD path (avoids globally installed pdd)
PDD_LOCAL_DIR := $(shell pwd)
PYTHONPATH_LOCAL := PYTHONPATH=$(PDD_LOCAL_DIR):$$PYTHONPATH

# Test files
TEST_PROMPT_DIR := /tmp/pdd_test_staging
TEST_PROMPT_FILE := $(TEST_PROMPT_DIR)/prompts/test_factorial.prompt
TEST_CODE_FILE := $(TEST_PROMPT_DIR)/src/factorial.py
TEST_OUTPUT_FILE := $(TEST_PROMPT_DIR)/tests/test_factorial_generated.py

# Colors for output
GREEN := \033[0;32m
YELLOW := \033[0;33m
RED := \033[0;31m
BLUE := \033[0;34m
NC := \033[0m

# ============================================================================
# Help
# ============================================================================
help:
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  PDD Test Command - Staging E2E Test Makefile$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@echo "$(GREEN)Token Management:$(NC)"
	@echo "  make -f Makefile.test-staging token        - Get fresh JWT token"
	@echo "  make -f Makefile.test-staging check-token  - Verify token is valid"
	@echo "  make -f Makefile.test-staging show-user    - Show user info from token"
	@echo ""
	@echo "$(GREEN)API Tests (Direct curl):$(NC)"
	@echo "  make -f Makefile.test-staging test-api          - Test generateTest endpoint"
	@echo "  make -f Makefile.test-staging test-api-examples - Check few-shot examples availability"
	@echo "  make -f Makefile.test-staging balance           - Check credit balance"
	@echo ""
	@echo "$(GREEN)CLI Tests:$(NC)"
	@echo "  make -f Makefile.test-staging test-cli     - Test 'pdd test' command with cloud"
	@echo ""
	@echo "$(GREEN)Full Test Suite:$(NC)"
	@echo "  make -f Makefile.test-staging full-test    - Run complete e2e test suite"
	@echo ""
	@echo "$(GREEN)Utilities:$(NC)"
	@echo "  make -f Makefile.test-staging create-test-files - Create test prompt/code files"
	@echo "  make -f Makefile.test-staging clean             - Remove generated files"
	@echo ""
	@echo "$(GREEN)Shortcuts:$(NC)"
	@echo "  make -f Makefile.test-staging t  - token"
	@echo "  make -f Makefile.test-staging u  - show-user"
	@echo "  make -f Makefile.test-staging b  - balance"
	@echo "  make -f Makefile.test-staging a  - test-api"
	@echo "  make -f Makefile.test-staging e  - test-api-examples"
	@echo "  make -f Makefile.test-staging c  - test-cli"
	@echo "  make -f Makefile.test-staging f  - full-test"
	@echo ""
	@echo "$(YELLOW)Note: Tokens expire after 1 hour. Run 'make token' to refresh.$(NC)"
	@echo ""

# ============================================================================
# Token Management
# ============================================================================
token:
	@echo "$(BLUE)Getting fresh staging JWT token...$(NC)"
	@python3 -c "import urllib.request, json, sys; \
		url='https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=$(STAGING_API_KEY)'; \
		payload={'email':'$(STAGING_EMAIL)','password':'$(STAGING_PASSWORD)','returnSecureToken':True}; \
		req=urllib.request.Request(url,json.dumps(payload).encode(),{'Content-Type':'application/json'}); \
		resp=urllib.request.urlopen(req,timeout=15); \
		token=json.loads(resp.read())['idToken']; \
		print(token,end='')" > $(TOKEN_FILE)
	@echo ""
	@echo "$(GREEN)Token saved to $(TOKEN_FILE)$(NC)"
	@echo "Token length: $$(wc -c < $(TOKEN_FILE)) bytes"
	@echo ""
	@echo "$(YELLOW)To use in your shell:$(NC)"
	@echo "  export PDD_JWT_TOKEN=\$$(cat $(TOKEN_FILE))"
	@echo "  export PDD_CLOUD_URL=$(STAGING_CLOUD_URL)"

check-token:
	@if [ ! -f $(TOKEN_FILE) ]; then \
		echo "$(RED)No token file found. Run 'make -f Makefile.test-staging token' first.$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)Checking token validity...$(NC)"
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' \
		-o /tmp/pdd_check_response.json; \
	if grep -q "credits" /tmp/pdd_check_response.json; then \
		echo "$(GREEN)Token is valid!$(NC)"; \
		python3 -c "import json; d=json.load(open('/tmp/pdd_check_response.json')); print(f'Balance: {d.get(\"credits\", \"?\")} PDDC')"; \
	else \
		echo "$(RED)Token is invalid or expired.$(NC)"; \
		cat /tmp/pdd_check_response.json; \
		echo "$(YELLOW)Run 'make -f Makefile.test-staging token' to get a new token.$(NC)"; \
		exit 1; \
	fi

show-user:
	@if [ ! -f $(TOKEN_FILE) ]; then \
		echo "$(RED)No token file found. Run 'make -f Makefile.test-staging token' first.$(NC)"; \
		exit 1; \
	fi
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	python3 -c "import base64,json; \
		token='$$TOKEN'.split('.')[1]; \
		padding='=' * (4 - len(token) % 4); \
		payload=json.loads(base64.urlsafe_b64decode(token + padding)); \
		print('Email:', payload.get('email', 'unknown')); \
		print('User ID:', payload.get('user_id', payload.get('sub', 'unknown'))); \
		import time; exp=payload.get('exp',0); \
		remaining=exp-int(time.time()); \
		print(f'Token expires in: {remaining//60} minutes')"

# ============================================================================
# API Tests
# ============================================================================
balance: check-token
	@echo ""
	@echo "$(BLUE)Checking credit balance...$(NC)"
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' \
		-o /tmp/pdd_balance_response.json; \
	python3 -c "import json; d=json.load(open('/tmp/pdd_balance_response.json')); \
		print(f'Balance: {d.get(\"credits\", \"?\")} PDDC')"

test-api: check-token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing generateTest API endpoint$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Sending request to generateTest...$(NC)"; \
	curl -s -X POST "$(STAGING_CLOUD_URL)/generateTest" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"promptContent": "Write a function to calculate factorial", "codeContent": "def factorial(n):\n    if n <= 1:\n        return 1\n    return n * factorial(n - 1)", "language": "python", "mode": "generate", "strength": 0.75, "temperature": 0.0, "verbose": true}' \
		-o $(RESPONSE_FILE); \
	echo ""; \
	echo "$(GREEN)Response Summary:$(NC)"; \
	python3 -c "import json; d=json.load(open('$(RESPONSE_FILE)')); print('  Credits Deducted:', d.get('creditsDeducted', '?')); print('  New Balance:', d.get('newBalance', '?'), 'PDDC'); print('  Total Cost: \$$' + str(round(d.get('totalCost', 0), 6))); print('  Model:', d.get('modelName', 'unknown')); print('  Generated Test Length:', len(d.get('generatedTest', '')), 'chars')"; \
	echo ""; \
	if grep -q "generatedTest" $(RESPONSE_FILE); then \
		echo "$(GREEN)API test PASSED$(NC)"; \
		echo ""; \
		echo "$(BLUE)Generated Test Preview (first 500 chars):$(NC)"; \
		python3 -c "import json; d=json.load(open('$(RESPONSE_FILE)')); print(d.get('generatedTest', '')[:500])"; \
	else \
		echo "$(RED)API test FAILED$(NC)"; \
		cat $(RESPONSE_FILE); \
		exit 1; \
	fi

test-api-examples: check-token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Checking Few-Shot Examples Availability$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	echo "$(YELLOW)Checking 'test' command examples...$(NC)"; \
	TEST_COUNT=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/reviewExamples" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"command": "test", "input": "factorial", "language": "python", "limit": 3}' | \
		python3 -c "import sys,json; d=json.load(sys.stdin); print(len(d.get('examples',[])))"); \
	echo "  'test' command: $$TEST_COUNT examples"; \
	echo ""; \
	echo "$(YELLOW)Checking 'fix' command examples...$(NC)"; \
	FIX_COUNT=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/reviewExamples" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"command": "fix", "input": "factorial", "language": "python", "limit": 3}' | \
		python3 -c "import sys,json; d=json.load(sys.stdin); print(len(d.get('examples',[])))"); \
	echo "  'fix' command: $$FIX_COUNT examples"; \
	echo ""; \
	echo "$(YELLOW)Checking 'generate' command examples...$(NC)"; \
	GEN_COUNT=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/reviewExamples" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{"command": "generate", "input": "factorial", "language": "python", "limit": 3}' | \
		python3 -c "import sys,json; d=json.load(sys.stdin); print(len(d.get('examples',[])))"); \
	echo "  'generate' command: $$GEN_COUNT examples"; \
	echo ""; \
	if [ "$$FIX_COUNT" -gt 0 ] || [ "$$GEN_COUNT" -gt 0 ]; then \
		echo "$(GREEN)Few-shot examples available for fallback!$(NC)"; \
	else \
		echo "$(YELLOW)Warning: No few-shot examples found. Test will proceed without enhancement.$(NC)"; \
	fi

# ============================================================================
# CLI Tests
# ============================================================================
create-test-files:
	@echo "$(BLUE)Creating test files...$(NC)"
	@mkdir -p $(TEST_PROMPT_DIR)/prompts
	@mkdir -p $(TEST_PROMPT_DIR)/src
	@mkdir -p $(TEST_PROMPT_DIR)/tests
	@echo "Write a function to calculate the factorial of a number" > $(TEST_PROMPT_FILE)
	@echo "def factorial(n):" > $(TEST_CODE_FILE)
	@echo "    \"\"\"Calculate the factorial of n.\"\"\"" >> $(TEST_CODE_FILE)
	@echo "    if n <= 1:" >> $(TEST_CODE_FILE)
	@echo "        return 1" >> $(TEST_CODE_FILE)
	@echo "    return n * factorial(n - 1)" >> $(TEST_CODE_FILE)
	@echo "$(GREEN)Created:$(NC)"
	@echo "  - $(TEST_PROMPT_FILE)"
	@echo "  - $(TEST_CODE_FILE)"

test-cli: check-token create-test-files
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Testing 'pdd test' CLI command with cloud$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@TOKEN=$$(cat $(TOKEN_FILE)); \
	BEFORE=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	echo "$(YELLOW)Balance before: $$BEFORE PDDC$(NC)"; \
	echo ""; \
	echo "$(YELLOW)Running: pdd --verbose test$(NC)"; \
	echo "$(YELLOW)Using local pdd via PYTHONPATH: $(PDD_LOCAL_DIR)$(NC)"; \
	echo ""; \
	export PDD_JWT_TOKEN=$$TOKEN; \
	export PDD_CLOUD_URL=$(STAGING_CLOUD_URL); \
	export PDD_AUTO_UPDATE=false; \
	cd $(TEST_PROMPT_DIR) && $(PYTHONPATH_LOCAL) python -m pdd.cli --force --verbose test \
		prompts/test_factorial.prompt \
		src/factorial.py \
		--output tests/test_factorial_generated.py 2>&1 | \
		grep -E "(Cloud|cloud|Success|success|Model|Cost|Attempting|Falling|staging|credits|Generated|Error|error)" | head -30; \
	echo ""; \
	AFTER=$$(curl -s -X POST "$(STAGING_CLOUD_URL)/getCreditBalance" \
		-H "Authorization: Bearer $$TOKEN" \
		-H "Content-Type: application/json" \
		-d '{}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('credits', 0))"); \
	DIFF=$$((BEFORE - AFTER)); \
	echo "$(YELLOW)Balance after: $$AFTER PDDC$(NC)"; \
	echo "$(GREEN)CLI test completed$(NC) - Credits used: $$DIFF"; \
	echo ""; \
	if [ -f $(TEST_OUTPUT_FILE) ]; then \
		echo "$(GREEN)Output file created: $(TEST_OUTPUT_FILE)$(NC)"; \
		echo ""; \
		echo "$(BLUE)Generated Test Preview (first 500 chars):$(NC)"; \
		head -c 500 $(TEST_OUTPUT_FILE); \
		echo ""; \
	else \
		echo "$(RED)Warning: Output file not created$(NC)"; \
	fi

# ============================================================================
# Full Test Suite
# ============================================================================
full-test: token
	@echo ""
	@echo "$(BLUE)=================================================$(NC)"
	@echo "$(BLUE)  Running Full generateTest E2E Test Suite$(NC)"
	@echo "$(BLUE)=================================================$(NC)"
	@echo ""
	@echo "$(YELLOW)Step 1/6: User Info$(NC)"
	@$(MAKE) -f Makefile.test-staging show-user --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 2/6: Starting Balance$(NC)"
	@$(MAKE) -f Makefile.test-staging balance --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 3/6: Few-Shot Examples Check$(NC)"
	@$(MAKE) -f Makefile.test-staging test-api-examples --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 4/6: API Endpoint Test$(NC)"
	@$(MAKE) -f Makefile.test-staging test-api --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 5/6: CLI Command Test$(NC)"
	@$(MAKE) -f Makefile.test-staging test-cli --no-print-directory
	@echo ""
	@echo "$(YELLOW)Step 6/6: Final Balance$(NC)"
	@$(MAKE) -f Makefile.test-staging balance --no-print-directory
	@echo ""
	@echo "$(GREEN)=================================================$(NC)"
	@echo "$(GREEN)  All generateTest E2E tests completed!$(NC)"
	@echo "$(GREEN)=================================================$(NC)"
	@echo ""
	@echo "$(YELLOW)Check gcloud logs for few-shot retrieval messages:$(NC)"
	@echo "  - 'Found few-shot example from ... command'"
	@echo "  - 'Enhanced prompt with ... command example'"
	@echo ""
	@echo "View credits at: https://prompt-driven-development-stg.web.app/admin"

# ============================================================================
# Utilities
# ============================================================================
clean:
	@echo "$(BLUE)Cleaning up test files...$(NC)"
	@rm -rf $(TEST_PROMPT_DIR)
	@rm -f $(TOKEN_FILE)
	@rm -f $(RESPONSE_FILE)
	@rm -f /tmp/pdd_check_response.json
	@rm -f /tmp/pdd_balance_response.json
	@echo "$(GREEN)Cleanup complete$(NC)"

show-env:
	@echo ""
	@echo "$(BLUE)Staging Environment Variables:$(NC)"
	@echo ""
	@if [ -f $(TOKEN_FILE) ]; then \
		echo "export PDD_JWT_TOKEN=\$$(cat $(TOKEN_FILE))"; \
	else \
		echo "# Token not found - run 'make -f Makefile.test-staging token' first"; \
	fi
	@echo "export PDD_CLOUD_URL=$(STAGING_CLOUD_URL)"
	@echo "export PYTHONPATH=$(PDD_LOCAL_DIR):\$$PYTHONPATH"
	@echo ""
	@echo "$(YELLOW)Copy and paste the above to set up your shell.$(NC)"

# ============================================================================
# Quick Commands (shortcuts)
# ============================================================================
t: token
u: show-user
b: balance
a: test-api
e: test-api-examples
c: test-cli
f: full-test
